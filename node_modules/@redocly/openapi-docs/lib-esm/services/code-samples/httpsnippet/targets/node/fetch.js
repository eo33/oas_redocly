import stringifyObject from"stringify-object";import{CodeBuilder}from"../../helpers/code-builder";import{addIndentation,getPreserveTransformer,buildUrlExpression,printUrlVariablesDeclarations}from"../../helpers/code-helpers";import{Lang}from"../../helpers/constants";import{normalizeMimeType}from"../../../../utils";import{HTTPSnippet}from"../..";import{MediaTypes}from"../../../../../constants";const handler=function(e,t,{target:a,client:n}){var s,i,r,o,d;const l=Object.assign({indent:"  ",showBoilerplate:!0,level:1},t),{level:p}=l;let h=!1;const c=new CodeBuilder({indentation:l.indent,variablesPrefix:l.variablesPrefix,capitalize:!0,lang:Lang.NODEJS});l.withComments&&addComments(c),l.withImports&&(c.push("import fetch from 'node-fetch';"),c.blank()),l.showBoilerplate&&c.push("async function run() {");const m={method:e.method.toUpperCase()};Object.keys(e.headersObj).length&&(m.headers=e.headersObj);let u=!1;if(null===(s=e.securityOAuth2ExtraCalls)||void 0===s?void 0:s.length){const t=new HTTPSnippet(null===(i=e.securityOAuth2ExtraCalls)||void 0===i?void 0:i[0]).convert(a,n,Object.assign(Object.assign({},l),{withImports:!1,withComments:!1,variablesPrefix:"oAuth2",showBoilerplate:!1,level:1}));c.push(t),c.blank(),m.headers=m.headers||{},m.headers.Authorization="'Bearer ' + oAuth2Data.access_token",u=!0}const f=Object.getOwnPropertyNames(e.queryObj).length;if(f&&c.push(p,`const ${c.var("query")} = new URLSearchParams(${addIndentation(stringifyObject(e.queryObj,{indent:l.indent,inlineCharacterLimit:25}),{level:p,indent:l.indent,firstLine:!1})}).toString();`).blank(),e.postData)switch(normalizeMimeType(e.postData.mimeType)){case MediaTypes.URL_ENCODED:m.body=e.postData.paramsObj?`new URLSearchParams(${c.var("formData")}).toString()`:e.postData.text,e.postData.paramsObj&&c.push(p,`const ${c.var("formData")} = ${addIndentation(stringifyObject(e.postData.paramsObj,{indent:l.indent,inlineCharacterLimit:25}),{level:p,firstLine:!1})};`).blank();break;case MediaTypes.JSON:e.postData.jsonObj&&(m.body=`JSON.stringify(${addIndentation(stringifyObject(e.postData.jsonObj,{indent:l.indent,inlineCharacterLimit:25}),{level:p,firstLine:!1})})`);break;case MediaTypes.MULTIPART:null===(r=null==m?void 0:m.headers)||void 0===r||delete r["Content-Type"],l.withImports&&c.unshift("import FormData from 'form-data';"),c.push(p,`const ${c.var("form")} = new FormData();`),e.postData.params.forEach((function(e){e.fileName||e.fileName||e.contentType?e.fileName&&(h=!0,c.blank(),c.push(p,`${c.var("form")}.append('" + param.name + "', fs.createReadStream('" + param.fileName + "'));`)):c.push(p,"form.append('"+e.name+"','"+e.value+"');")})),m.body=c.var("form"),c.blank();break;default:e.postData.text&&(m.body=`\`${addIndentation(e.postData.text,{level:p+1,indent:l.indent,firstLine:!1}).trim()}\``)}if(e.cookies.length){let t="";e.cookies.forEach((function(e){t=t+encodeURIComponent(e.name)+"="+encodeURIComponent(e.value)+"; "})),t=t.trim(),m.headers||(m.headers={}),m.headers.cookie=t}if(e.basicAuth){const{username:t,password:a}=e.basicAuth;m.headers=m.headers||{},m.headers.Authorization=`'Basic ' + Buffer.from('${t}:${a}').toString('base64')`,u=!0}h&&l.withImports&&c.unshift("import fs from 'fs';");const b=m.headers&&m.headers.Accept&&normalizeMimeType(m.headers.Accept)===MediaTypes.JSON||normalizeMimeType(null===(o=e.postData)||void 0===o?void 0:o.mimeType)===MediaTypes.JSON;printUrlVariablesDeclarations(e,c,p);const v=buildUrlExpression(e,c);return c.push(p,`const ${c.var("resp")} = await fetch(`).push(p+1,"`"+v+(f?"?${"+c.var("query")+"}":"")+"`,").push(p+1,addIndentation(stringifyObject(m,{indent:l.indent,inlineCharacterLimit:25,transform:getPreserveTransformer({body:!0,authorizationHeader:u})}),{level:p+1,indent:l.indent,firstLine:!1})).push(p,");").blank(),(null===(d=e.allResponseCodes)||void 0===d?void 0:d.includes("204"))?(c.push(p,"if (resp.status === 204) {").push(p+1,"console.log('success');").push(p,"} else {"),c.push(p+1,`const ${c.var("data")} = await ${c.var("resp")}.${b?"json()":"text()"};`).push(p+1,`console.log(${c.var("data")});`).push(p,"}")):c.push(p,`const ${c.var("data")} = await ${c.var("resp")}.${b?"json()":"text()"};`).push(p,`console.log(${c.var("data")});`),l.showBoilerplate&&c.push("}").blank().push("run();"),c.join().replace(/"fs\.createReadStream\(\\"(.+)\\"\)"/,'fs.createReadStream("$1")')};function addComments(e){e.push("/**"),e.push(" * Requires Node.js >= 14"),e.push(" *"),e.push(' * Requires module "node-fetch" >= 2.6.1'),e.push(" * See here for installation details:"),e.push(" *   https://www.npmjs.com/package/node-fetch"),e.push(" */"),e.blank()}export const info={key:"fetch",title:"Fetch",link:"https://github.com/bitinn/node-fetch",description:"Simplified HTTP node-fetch client"};export default handler;
//# sourceMappingURL=fetch.js.map