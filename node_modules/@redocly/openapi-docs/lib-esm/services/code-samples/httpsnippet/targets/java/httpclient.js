import{CodeBuilder}from"../../helpers/code-builder";import{HTTPSnippet}from"../..";import{normalizeMimeType}from"../../../../utils";import{addIndentation,buildUrlExpression,printUrlVariablesDeclarations}from"../../helpers/code-helpers";import{Lang}from"../../helpers/constants";import{MediaTypes}from"../../../../../constants";const hasQueryParams=t=>!(!t.uriObj.query||!Object.keys(t.uriObj.query).length),getBody=t=>t.postData&&t.postData.mimeType===MediaTypes.URL_ENCODED?"HttpRequest.BodyPublishers.ofString(form)":t.postData?"HttpRequest.BodyPublishers.ofString(payload)":["POST","PUT","PATCH"].includes(t.method.toUpperCase())?'HttpRequest.BodyPublishers.ofString("some body text")':"",handler=function(t,e,{target:a,client:s}){var r,o,p;const i=Object.assign({indent:"  ",withWrapper:!0},e),n=new CodeBuilder({indentation:i.indent,variablesPrefix:i.variablesPrefix,capitalize:!0,lang:Lang.JAVA});if(i.withComments&&addComments(n,t),i.withImports&&addImports(n,t),i.withWrapper&&(n.push("public class App {"),n.push(1,"public static void main(String[] args) throws Exception {"),n.push(2,"var httpClient = HttpClient.newBuilder().build();"),n.blank()),null===(r=t.securityOAuth2ExtraCalls)||void 0===r?void 0:r.length){const e=new HTTPSnippet(null===(o=t.securityOAuth2ExtraCalls)||void 0===o?void 0:o[0]).convert(a,s,Object.assign(Object.assign({},i),{withImports:!1,withWrapper:!1,withComments:!1,variablesPrefix:"oauth2"}));n.push(e),n.blank(),n.push(2,"var oauth2Response = httpClient.send(oauth2Request, HttpResponse.BodyHandlers.ofString());"),n.push(2,'var accessToken = new JSONObject(oauth2Response.body()).getString("access_token");'),n.blank()}if(t.postData)switch(normalizeMimeType(t.postData.mimeType)){case MediaTypes.URL_ENCODED:t.postData.params&&(n.push(2,"HashMap<String, String> params = new HashMap<>();"),t.postData.params.forEach((t=>{n.push(2,'params.put("%s", "%s");',t.name,t.value)})),n.blank(),n.push(2,"var form = params.keySet().stream()"),n.push(3,'.map(key -> key + "=" + URLEncoder.encode(params.get(key), StandardCharsets.UTF_8))'),n.push(3,'.collect(Collectors.joining("&"));'),n.blank());break;case MediaTypes.JSON:t.postData.jsonObj&&(n.push(2,`var payload = String.join("\\n"\n      ${addIndentation(JSON.stringify(t.postData.jsonObj,null,1).replace(/"/g,'\\"').replace(/^/gm,', "').replace(/$/gm,'"'),{level:3,indent:i.indent,firstLine:!1})}`),n.push(2,");"),n.blank());break;case MediaTypes.XML:t.postData.text&&(n.push(2,'var payload = String.join("\\n"'),t.postData.text.trim().split("\n").forEach((t=>{const e=t.replace(/"/g,'\\"');n.push(3,`"${e}", `)})),n.push(2,");"),n.blank());break;case MediaTypes.MULTIPART:t.postData.params&&(n.push(2,"var multipartBody = MultipartBodyPublisher.newBuilder();"),t.postData.params&&t.postData.params.forEach((t=>{n.push(2,'multipartBody.append("%s", "%s");',t.name,t.value)})),n.push(2,"var body = multipartBody.build();"),n.blank())}if(hasQueryParams(t)){n.push(2,"HashMap<String, String> params = new HashMap<>();");for(const[e,a]of Object.entries(t.uriObj.query))n.push(2,'params.put("%s", "%s");',e,a);n.blank(),n.push(2,"var query = params.keySet().stream()"),n.push(3,'.map(key -> key + "=" + URLEncoder.encode(params.get(key), StandardCharsets.UTF_8))'),n.push(3,'.collect(Collectors.joining("&"));'),n.blank()}n.push(2,`var ${n.var("host")} = "%s";`,t.uriObj.protocol+"//"+t.uriObj.host),printUrlVariablesDeclarations(t,n,2);const l=Object.assign(Object.assign({},t),{pathname:t.uriObj.pathname});n.push(2,`var ${n.var("pathname")} = %s;`,buildUrlExpression(l,n)),n.push(2,`var ${n.var("request")} = HttpRequest.newBuilder()`),"PATCH"===t.method.toUpperCase()?n.push(3,'.method("PATCH", %s)',getBody(t)):n.push(3,".%s(%s)",t.method.toUpperCase(),getBody(t)),n.push(3,`.uri(URI.create(${n.var("host")} + ${n.var("pathname")} %s))`,hasQueryParams(t)?"+ '?' + query":""),(null===(p=t.securityOAuth2ExtraCalls)||void 0===p?void 0:p.length)&&(t.allHeaders.Authorization='"Bearer " + accessToken');const u=Object.keys(t.allHeaders);if(u.length&&u.forEach((e=>{var a;n.push(3,'.header("%s", %s)',e,"Authorization"===e&&(null===(a=t.securityOAuth2ExtraCalls)||void 0===a?void 0:a.length)?t.allHeaders[e]:`"${t.allHeaders[e]}"`)})),t.basicAuth){const{username:e,password:a}=t.basicAuth;n.push(3,`.header("Authorization", "Basic " + Base64.getEncoder().encodeToString(("${e}:${a}").getBytes()))`)}return n.push(3,".build();"),i.withWrapper&&(n.blank(),n.push(2,"var response = httpClient.send(request, HttpResponse.BodyHandlers.ofString());"),n.blank(),n.push(2,"System.out.println(response.body());"),n.push(1,"}"),n.push("}")),n.join()};export const info={key:"httpclient",title:"HttpClient",link:"https://docs.oracle.com/en/java/javase/11/docs/api/java.net.http/java/net/http/HttpClient.html",description:"HttpClient (Java SE 11 & JDK 11 )"};export default handler;function addComments(t,e){var a;t.push("/**"),t.push(" * Requires JDK >= 11"),(null===(a=e.securityOAuth2ExtraCalls)||void 0===a?void 0:a.length)&&(t.push(" *"),t.push(' * Requires package "org.json" >= 20201115'),t.push(" * See here for installation details:"),t.push(" *  https://search.maven.org/artifact/org.json/json")),t.push(" */"),t.blank()}function addImports(t,e){var a,s,r,o;t.push("import java.net.*;"),t.push("import java.net.http.*;"),t.push("import java.util.*;"),(normalizeMimeType(null===(a=e.postData)||void 0===a?void 0:a.mimeType)===MediaTypes.URL_ENCODED&&(null===(s=e.postData)||void 0===s?void 0:s.params)||(null===(r=e.securityOAuth2ExtraCalls)||void 0===r?void 0:r.length)||hasQueryParams(e))&&(t.push("import java.nio.charset.StandardCharsets;"),t.push("import java.util.stream.Collectors;")),(null===(o=e.securityOAuth2ExtraCalls)||void 0===o?void 0:o.length)&&t.push("import org.json.JSONObject;"),t.blank()}
//# sourceMappingURL=httpclient.js.map