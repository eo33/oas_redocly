import stringifyObject from"stringify-object";import{CodeBuilder}from"../../helpers/code-builder";import{addIndentation,getPreserveTransformer,buildUrlExpression,printUrlVariablesDeclarations}from"../../helpers/code-helpers";import{normalizeMimeType}from"../../../../utils";import{HTTPSnippet}from"../..";import{Lang}from"../../helpers/constants";import{MediaTypes}from"../../../../../constants";const handler=function(e,t,{target:a,client:n}){var s,r,i,o,d;const l=Object.assign({indent:"  ",credentials:null},t),p=new CodeBuilder({indentation:l.indent,variablesPrefix:l.variablesPrefix,capitalize:!0,lang:Lang.JAVASCRIPT}),c={method:e.method.toUpperCase()};Object.keys(e.headersObj).length&&(c.headers=e.headersObj);let h=!1;if(l.withComments&&addComments(p),null===(s=e.securityOAuth2ExtraCalls)||void 0===s?void 0:s.length){const t=new HTTPSnippet(null===(r=e.securityOAuth2ExtraCalls)||void 0===r?void 0:r[0]).convert(a,n,Object.assign(Object.assign({},l),{withImports:!1,withComments:!1,variablesPrefix:"oAuth2"}));p.push(t),p.blank(),c.headers=c.headers||{},c.headers.Authorization="'Bearer ' + oAuth2Data.access_token",h=!0}null!==l.credentials&&(c.credentials=l.credentials);const m=Object.getOwnPropertyNames(e.queryObj).length;if(m&&p.push(`const ${p.var("query")} = new URLSearchParams(${stringifyObject(e.queryObj,{indent:l.indent,inlineCharacterLimit:25})}).toString();`).blank(),e.postData)switch(normalizeMimeType(e.postData.mimeType)){case MediaTypes.URL_ENCODED:c.body=e.postData.paramsObj?`new URLSearchParams(${p.var("formData")}).toString()`:e.postData.text,e.postData.paramsObj&&p.push(`const ${p.var("formData")} = ${addIndentation(stringifyObject(e.postData.paramsObj,{indent:l.indent,inlineCharacterLimit:25}),{level:0,firstLine:!1})};`).blank();break;case MediaTypes.JSON:e.postData.jsonObj&&(c.body=`JSON.stringify(${addIndentation(stringifyObject(e.postData.jsonObj,{indent:l.indent,inlineCharacterLimit:25}),{level:1,firstLine:!1})})`);break;case MediaTypes.MULTIPART:p.push(`const ${p.var("form")} = new FormData();`),null===(i=null==c?void 0:c.headers)||void 0===i||delete i["Content-Type"],e.postData.params.forEach((function(e){p.push(`${p.var("form")}.append(%s, %s);`,JSON.stringify(e.name),JSON.stringify(e.value||e.fileName||""))})),c.body=p.var("form"),p.blank();break;default:e.postData.text&&(c.body=`\`${addIndentation(e.postData.text,{level:2,indent:l.indent,firstLine:!1}).trim()}\``)}const u=c.headers&&c.headers.Accept&&normalizeMimeType(c.headers.Accept)===MediaTypes.JSON||normalizeMimeType(null===(o=e.postData)||void 0===o?void 0:o.mimeType)===MediaTypes.JSON;if(e.basicAuth){const{username:t,password:a}=e.basicAuth;c.headers=c.headers||{},c.headers.Authorization=`'Basic ' + btoa('${t}:${a}')`,h=!0}printUrlVariablesDeclarations(e,p);const b=buildUrlExpression(e,p);return p.push(`const ${p.var("resp")} = await fetch(`).push(1,"`"+b+(m?"?${"+p.var("query")+"}":"")+"`,").push(addIndentation(stringifyObject(c,{indent:l.indent,inlineCharacterLimit:25,transform:getPreserveTransformer({body:!0,authorizationHeader:h})}),{level:1,indent:l.indent})).push(");").blank(),(null===(d=e.allResponseCodes)||void 0===d?void 0:d.includes("204"))?(p.push("if (resp.status === 204) {").push(1,"console.log('success');").push("} else {"),p.push(1,`const ${p.var("data")} = await ${p.var("resp")}.${u?"json()":"text()"};`).push(1,`console.log(${p.var("data")});`).push("}")):p.push(`const ${p.var("data")} = await ${p.var("resp")}.${u?"json()":"text()"};`).push(`console.log(${p.var("data")});`),p.join()};function addComments(e){e.push("/**"),e.push(" * Requires ES8-compatible browser: https://caniuse.com/async-functions"),e.push(" */"),e.blank()}export const info={key:"fetch",title:"fetch",link:"https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch",description:"Perform asynchronous HTTP requests with the Fetch API"};export default handler;
//# sourceMappingURL=fetch.js.map