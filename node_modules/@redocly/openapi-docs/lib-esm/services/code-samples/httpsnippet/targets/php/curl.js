import{format}from"util";import{CodeBuilder}from"../../helpers/code-builder";import{HTTPSnippet}from"../..";import{Lang}from"../../helpers/constants";import{buildUrlExpression,printUrlVariablesDeclarations}from"../../helpers/code-helpers";import{startCase}from"../../helpers/lodash-int";import{normalizeMimeType}from"../../../../utils";import{MediaTypes}from"../../../../../constants";import{objectToPhpArray}from"./utils";function getVariableName(e,a){return a?`$${a}${startCase(e)}`:`$${e}`}const handler=function(e,a,{target:r,client:t}){var n;const s=Object.assign({showBoilerplate:!0,checkErrors:!1,printBody:!0,indent:"  ",noTags:!0,shortTags:!1,maxRedirects:10,namedErrors:!1,closingTag:!1},a);let o,i=!1;const l=new CodeBuilder({indentation:s.indent,capitalize:!0,lang:Lang.PHP}),p=null===(n=e.securityOAuth2ExtraCalls)||void 0===n?void 0:n[0],u=getVariableName("curl",s.variablesPrefix),c=getVariableName("response",s.variablesPrefix),h=getVariableName("error",s.variablesPrefix);if(s.noTags||l.push(s.shortTags?"<?":"<?php").blank(),p){const a="oAuth2",n=new HTTPSnippet(p).convert(r,t,Object.assign(Object.assign({},s),{showBoilerplate:!1,variablesPrefix:a}));l.push(n),l.blank(),e.allHeaders.Authorization=`Bearer " . ${getVariableName("response",a)}.access_token`}const d=Object.keys(e.headersObj).sort().map((function(a){return"Authorization"===a&&p?format('"%s: %s',a,e.allHeaders.Authorization):format('"%s: %s"',a,e.headersObj[a])}));if(e.basicAuth){const{username:a,password:r}=e.basicAuth;d.push(`"Authorization: Basic " . base64_encode("${a}:${r}")`)}s.showBoilerplate&&l.push("/**").push(" * Requires libcurl").push(" */").blank(),printUrlVariablesDeclarations(e,l);let m="";if(Object.keys(e.queryObj||{}).length){const a=objectToPhpArray(e.queryObj||{},{indent:s.indent});m="$query",l.push(`${m} = ${a};`).blank()}if(l.push(`${u} = curl_init();`),l.blank(),e.postData)switch(normalizeMimeType(e.postData.mimeType)){case MediaTypes.JSON:{const a=objectToPhpArray(e.postData.jsonObj||{},{indent:s.indent});i=!0,o="json_encode($payload)",l.push(`$payload = ${a};`).blank();break}case MediaTypes.MULTIPART:{const a=e.postData.params.map((({name:e,value:a})=>`${s.indent}"${e}" => "${a}",\n`)).join("");i=!0,o="$payload",l.push(`$payload = array(\n${a});`).blank();break}case MediaTypes.URL_ENCODED:{const a=e.postData.params.map((({name:e,value:a})=>`${e}=${a}`)).join("&");i=!0,o="$payload",l.push(`$payload = "${a}";`).blank();break}default:o=e.postData.text}let b=buildUrlExpression(e,l);m&&(b.endsWith('"')?b=b.slice(0,-1)+`?" . http_build_query(${m})`:b+=` . "?" . http_build_query(${m})`);const $=[{escape:!i,name:"CURLOPT_POSTFIELDS",value:o},{escape:!0,name:"CURLOPT_PORT",value:e.uriObj.port},{escape:!1,name:"CURLOPT_URL",value:b},{escape:!1,name:"CURLOPT_RETURNTRANSFER",value:"true"},{escape:!0,name:"CURLOPT_CUSTOMREQUEST",value:e.method.toUpperCase()}];l.push(`curl_setopt_array(${u}, [`);const T=new CodeBuilder({indentation:s.indent,lineJoin:`\n${s.indent}`,variablesPrefix:s.variablesPrefix,capitalize:!0,lang:Lang.PHP});d.length&&T.push("CURLOPT_HTTPHEADER => [").push(1,d.join(",\n"+s.indent+s.indent)).push("],"),$.forEach((function(e){[null,void 0].includes(e.value)||T.push(format("%s => %s,",e.name,e.escape?JSON.stringify(e.value):e.value))}));const f=e.cookies.map((function(e){return encodeURIComponent(e.name)+"="+encodeURIComponent(e.value)}));return f.length&&T.push(format('CURLOPT_COOKIE => "%s",',f.join("; "))),l.push(1,T.join()).push("]);").blank().push(`${c} = curl_exec(${u});`).push(`${h} = curl_error(${u});`).blank().push(`curl_close(${u});`).blank().push(`if (${h}) {`),s.namedErrors?l.push(1,`echo array_flip(get_defined_constants(true)["curl"])[${h}];`):l.push(1,`echo "cURL Error #:" . ${h};`),l.push("} else {").push(1,`echo ${c};`).push("}"),!s.noTags&&s.closingTag&&l.blank().push("?>"),l.join()};export const info={key:"curl",title:"cURL",link:"http://php.net/manual/en/book.curl.php",description:"PHP with ext-curl"};export default handler;
//# sourceMappingURL=curl.js.map