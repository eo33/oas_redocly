import{CodeBuilder}from"../../helpers/code-builder";import{HTTPSnippet}from"../..";import{Lang}from"../../helpers/constants";import{buildUrlExpression,printUrlVariablesDeclarations}from"../../helpers/code-helpers";import{normalizeMimeType}from"../../../../utils";import{MediaTypes}from"../../../../../constants";const indent=1;function hasMimeType(e={},s){return normalizeMimeType(e.mimeType)===s}const handler=function(e,s,{target:a,client:r}){var t,i,p,o,n,l;const u=Object.assign({capitalize:!0,showBoilerplate:!0,checkErrors:!0,printBody:!0,timeout:-1,indent:"  "},s),h=null===(t=e.securityOAuth2ExtraCalls)||void 0===t?void 0:t[0],d=u.checkErrors?"err":"_",c=e.method.toUpperCase(),y=new CodeBuilder({indentation:u.indent,variablesPrefix:u.variablesPrefix,capitalize:u.capitalize,lang:Lang.GO}),v=()=>{u.checkErrors&&y.push(1,"if err != nil {").push(2,"panic(err)").push(1,"}")};if(u.showBoilerplate&&(y.push("package main").blank().push("import (").push(1,'"fmt"'),u.timeout>0&&y.push(1,'"time"'),h&&y.push(1,'"encoding/json"'),hasMimeType(e.postData,MediaTypes.MULTIPART)&&(y.push(1,'"mime/multipart"'),y.push(1,'"io"'),y.push(1,'"bytes"')),(hasMimeType(e.postData,MediaTypes.URL_ENCODED)||hasMimeType(null===(p=null===(i=e.securityOAuth2ExtraCalls)||void 0===i?void 0:i[0])||void 0===p?void 0:p.postData,MediaTypes.URL_ENCODED))&&(y.push(1,'"net/url"'),y.push(1,'"strconv"')),(hasMimeType(e.postData,MediaTypes.JSON)||hasMimeType(null===(n=null===(o=e.securityOAuth2ExtraCalls)||void 0===o?void 0:o[0])||void 0===n?void 0:n.postData,MediaTypes.JSON))&&y.push(1,'"bytes"'),(e.postData&&!hasMimeType(e.postData,MediaTypes.JSON)||h)&&y.push(1,'"strings"'),y.push(1,'"net/http"'),u.printBody&&y.push(1,'"io/ioutil"'),y.push(")").blank().push("func main() {")),Object.keys(e.allHeaders).length&&Object.keys(e.allHeaders).forEach((s=>{e.allHeaders[s]=`"${e.allHeaders[s]}"`})),h){const s="oAuth2",t=u.checkErrors?`${d} := `:"",i=u.capitalize?"Res":"res",p=new HTTPSnippet(h).convert(a,r,Object.assign(Object.assign({},u),{printBody:!1,variablesPrefix:s,showBoilerplate:!1}));y.push(p).blank().push(1,`var ${s}${i}Body struct {`).push(2,"Access_token string").push(1,"}").push(1,`${t}json.NewDecoder(${s}${i}.Body).Decode(&${s}${i}Body)`).blank(),v(),e.allHeaders.Authorization=`"Bearer " + ${s}${i}Body.Access_token`}if(printUrlVariablesDeclarations(e,y,1),u.timeout>0&&(r=y.var("client"),y.push(1,"%s := http.Client{",r).push(2,"Timeout: time.Duration(%s * time.Second),",u.timeout).push(1,"}").blank()),y.push(1,`${y.var("reqUrl")} := ${buildUrlExpression(e,y)}`),e.postData){let s;switch(normalizeMimeType(e.postData.mimeType)){case MediaTypes.URL_ENCODED:y.push(1,"%s := url.Values{}",y.var("data")),e.postData.params.forEach((e=>{y.push(1,'%s.Set("%s", "%s")',y.var("data"),e.name,e.value)})),y.push(1,'%s, %s := http.NewRequest("%s", %s, strings.NewReader(%s.Encode()))',y.var("req"),d,c,y.var("reqUrl"),y.var("data")),e.allHeaders["Content-Length"]=`strconv.Itoa(len(${y.var("data")}.Encode()))`;break;case MediaTypes.JSON:s=JSON.stringify(e.postData.jsonObj,null,2).split("\n").map((e=>u.indent+e)).join("\n").trim(),y.push(1,`var ${y.var("data")} = []byte(\`${s}\`)`),y.push(1,'%s, %s := http.NewRequest("%s", %s, bytes.NewBuffer(%s))',y.var("req"),d,c,y.var("reqUrl"),y.var("data"));break;case MediaTypes.MULTIPART:y.push(1,"%s := &bytes.Buffer{}",y.var("data")).push(1,"writer := multipart.NewWriter(%s)",y.var("data")),e.postData.params.forEach((e=>{if(!e.fileName&&!e.contentType)return y.push(1,'%s, _ := writer.CreateFormField("%s")',y.var(`${e.name}Fw`),e.name).push(1,'_, %s = io.Copy(%s, strings.NewReader("%s"))',d,y.var(`${e.name}Fw`),e.value),void v();e.fileName&&(y.push(1,'%s, %s = writer.CreateFormFile("%s", "%s")',y.var(`${e.name}Fw`),d,e.name,e.fileName),v())})),y.push(1,"writer.Close()").blank().push(1,"%s := bytes.NewReader(%s.Bytes())",y.var("payload"),y.var("data")).push(1,'%s, %s := http.NewRequest("%s", %s, %s)',y.var("req"),d,c,y.var("reqUrl"),y.var("payload")),e.allHeaders["Content-Type"]="writer.FormDataContentType()";break;default:e.postData.text&&y.push(1,"%s := strings.NewReader(%s)",y.var("payload"),JSON.stringify(null===(l=e.postData)||void 0===l?void 0:l.text)).push(1,'%s, %s := http.NewRequest("%s", %s, %s)',y.var("req"),d,c,y.var("reqUrl"),y.var("payload"))}}else y.push(1,'%s, %s := http.NewRequest("%s", %s, nil)',y.var("req"),d,c,y.var("reqUrl"));if(Object.getOwnPropertyNames(e.queryObj).length){y.blank().push(1,`${y.var("query")} := ${y.var("req")}.URL.Query()`);for(const s in e.queryObj){const a=e.queryObj[s],r="string"==typeof a&&/^\[.*\]$/.test(a)?`\`${a}\``:`"${a}"`;y.push(1,`${y.var("query")}.Add("${s}", ${r})`)}y.push(1,`${y.var("req")}.URL.RawQuery = ${y.var("query")}.Encode()`).blank()}if(v(),e.basicAuth){const{username:s,password:a}=e.basicAuth;y.push(1,`%s.SetBasicAuth("${s}", "${a}")`,y.var("req"))}return Object.keys(e.allHeaders).length&&Object.keys(e.allHeaders).forEach((s=>{y.push(1,'%s.Header.Add("%s", %s)',y.var("req"),s,e.allHeaders[s])})),y.push(1,"%s, %s := %s.Do(%s)",y.var("res"),d,r,y.var("req")),v(),u.printBody&&(y.push(1,"defer %s.Body.Close()",y.var("res")).push(1,"%s, %s := ioutil.ReadAll(%s.Body)",y.var("body"),d,y.var("res")),v()),y.blank().push(1,"fmt.Println(%s)",y.var("res")),u.printBody&&y.push(1,"fmt.Println(string(%s))",y.var("body")),u.showBoilerplate&&y.push("}"),y.join()};export const info={key:"native",title:"NewRequest",link:"http://golang.org/pkg/net/http/#NewRequest",description:"Golang HTTP client request"};export default handler;
//# sourceMappingURL=native.js.map