"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.info=void 0;const stringify_object_1=__importDefault(require("stringify-object")),code_builder_1=require("../../helpers/code-builder"),code_helpers_1=require("../../helpers/code-helpers"),constants_1=require("../../helpers/constants"),utils_1=require("../../../../utils"),__1=require("../.."),constants_2=require("../../../../../constants"),handler=function(e,t,{target:a,client:s}){var n,r,i,o,l;const d=Object.assign({indent:"  ",showBoilerplate:!0,level:1},t),{level:p}=d;let c=!1;const h=new code_builder_1.CodeBuilder({indentation:d.indent,variablesPrefix:d.variablesPrefix,capitalize:!0,lang:constants_1.Lang.NODEJS});d.withComments&&addComments(h),d.withImports&&(h.push("import fetch from 'node-fetch';"),h.blank()),d.showBoilerplate&&h.push("async function run() {");const u={method:e.method.toUpperCase()};Object.keys(e.headersObj).length&&(u.headers=e.headersObj);let m=!1;if(null===(n=e.securityOAuth2ExtraCalls)||void 0===n?void 0:n.length){const t=new __1.HTTPSnippet(null===(r=e.securityOAuth2ExtraCalls)||void 0===r?void 0:r[0]).convert(a,s,Object.assign(Object.assign({},d),{withImports:!1,withComments:!1,variablesPrefix:"oAuth2",showBoilerplate:!1,level:1}));h.push(t),h.blank(),u.headers=u.headers||{},u.headers.Authorization="'Bearer ' + oAuth2Data.access_token",m=!0}const f=Object.getOwnPropertyNames(e.queryObj).length;if(f&&h.push(p,`const ${h.var("query")} = new URLSearchParams(${(0,code_helpers_1.addIndentation)((0,stringify_object_1.default)(e.queryObj,{indent:d.indent,inlineCharacterLimit:25}),{level:p,indent:d.indent,firstLine:!1})}).toString();`).blank(),e.postData)switch((0,utils_1.normalizeMimeType)(e.postData.mimeType)){case constants_2.MediaTypes.URL_ENCODED:u.body=e.postData.paramsObj?`new URLSearchParams(${h.var("formData")}).toString()`:e.postData.text,e.postData.paramsObj&&h.push(p,`const ${h.var("formData")} = ${(0,code_helpers_1.addIndentation)((0,stringify_object_1.default)(e.postData.paramsObj,{indent:d.indent,inlineCharacterLimit:25}),{level:p,firstLine:!1})};`).blank();break;case constants_2.MediaTypes.JSON:e.postData.jsonObj&&(u.body=`JSON.stringify(${(0,code_helpers_1.addIndentation)((0,stringify_object_1.default)(e.postData.jsonObj,{indent:d.indent,inlineCharacterLimit:25}),{level:p,firstLine:!1})})`);break;case constants_2.MediaTypes.MULTIPART:null===(i=null==u?void 0:u.headers)||void 0===i||delete i["Content-Type"],d.withImports&&h.unshift("import FormData from 'form-data';"),h.push(p,`const ${h.var("form")} = new FormData();`),e.postData.params.forEach((function(e){e.fileName||e.fileName||e.contentType?e.fileName&&(c=!0,h.blank(),h.push(p,`${h.var("form")}.append('" + param.name + "', fs.createReadStream('" + param.fileName + "'));`)):h.push(p,"form.append('"+e.name+"','"+e.value+"');")})),u.body=h.var("form"),h.blank();break;default:e.postData.text&&(u.body=`\`${(0,code_helpers_1.addIndentation)(e.postData.text,{level:p+1,indent:d.indent,firstLine:!1}).trim()}\``)}if(e.cookies.length){let t="";e.cookies.forEach((function(e){t=t+encodeURIComponent(e.name)+"="+encodeURIComponent(e.value)+"; "})),t=t.trim(),u.headers||(u.headers={}),u.headers.cookie=t}if(e.basicAuth){const{username:t,password:a}=e.basicAuth;u.headers=u.headers||{},u.headers.Authorization=`'Basic ' + Buffer.from('${t}:${a}').toString('base64')`,m=!0}c&&d.withImports&&h.unshift("import fs from 'fs';");const _=u.headers&&u.headers.Accept&&(0,utils_1.normalizeMimeType)(u.headers.Accept)===constants_2.MediaTypes.JSON||(0,utils_1.normalizeMimeType)(null===(o=e.postData)||void 0===o?void 0:o.mimeType)===constants_2.MediaTypes.JSON;(0,code_helpers_1.printUrlVariablesDeclarations)(e,h,p);const b=(0,code_helpers_1.buildUrlExpression)(e,h);return h.push(p,`const ${h.var("resp")} = await fetch(`).push(p+1,"`"+b+(f?"?${"+h.var("query")+"}":"")+"`,").push(p+1,(0,code_helpers_1.addIndentation)((0,stringify_object_1.default)(u,{indent:d.indent,inlineCharacterLimit:25,transform:(0,code_helpers_1.getPreserveTransformer)({body:!0,authorizationHeader:m})}),{level:p+1,indent:d.indent,firstLine:!1})).push(p,");").blank(),(null===(l=e.allResponseCodes)||void 0===l?void 0:l.includes("204"))?(h.push(p,"if (resp.status === 204) {").push(p+1,"console.log('success');").push(p,"} else {"),h.push(p+1,`const ${h.var("data")} = await ${h.var("resp")}.${_?"json()":"text()"};`).push(p+1,`console.log(${h.var("data")});`).push(p,"}")):h.push(p,`const ${h.var("data")} = await ${h.var("resp")}.${_?"json()":"text()"};`).push(p,`console.log(${h.var("data")});`),d.showBoilerplate&&h.push("}").blank().push("run();"),h.join().replace(/"fs\.createReadStream\(\\"(.+)\\"\)"/,'fs.createReadStream("$1")')};function addComments(e){e.push("/**"),e.push(" * Requires Node.js >= 14"),e.push(" *"),e.push(' * Requires module "node-fetch" >= 2.6.1'),e.push(" * See here for installation details:"),e.push(" *   https://www.npmjs.com/package/node-fetch"),e.push(" */"),e.blank()}exports.info={key:"fetch",title:"Fetch",link:"https://github.com/bitinn/node-fetch",description:"Simplified HTTP node-fetch client"},exports.default=handler;
//# sourceMappingURL=fetch.js.map