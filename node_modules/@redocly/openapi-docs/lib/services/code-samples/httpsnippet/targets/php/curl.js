"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.info=void 0;const util_1=require("util"),code_builder_1=require("../../helpers/code-builder"),__1=require("../.."),constants_1=require("../../helpers/constants"),code_helpers_1=require("../../helpers/code-helpers"),lodash_int_1=require("../../helpers/lodash-int"),utils_1=require("../../../../utils"),constants_2=require("../../../../../constants"),utils_2=require("./utils");function getVariableName(e,a){return a?`$${a}${(0,lodash_int_1.startCase)(e)}`:`$${e}`}const handler=function(e,a,{target:s,client:t}){var n;const r=Object.assign({showBoilerplate:!0,checkErrors:!1,printBody:!0,indent:"  ",noTags:!0,shortTags:!1,maxRedirects:10,namedErrors:!1,closingTag:!1},a);let i,o=!1;const l=new code_builder_1.CodeBuilder({indentation:r.indent,capitalize:!0,lang:constants_1.Lang.PHP}),u=null===(n=e.securityOAuth2ExtraCalls)||void 0===n?void 0:n[0],p=getVariableName("curl",r.variablesPrefix),c=getVariableName("response",r.variablesPrefix),h=getVariableName("error",r.variablesPrefix);if(r.noTags||l.push(r.shortTags?"<?":"<?php").blank(),u){const a="oAuth2",n=new __1.HTTPSnippet(u).convert(s,t,Object.assign(Object.assign({},r),{showBoilerplate:!1,variablesPrefix:a}));l.push(n),l.blank(),e.allHeaders.Authorization=`Bearer " . ${getVariableName("response",a)}.access_token`}const d=Object.keys(e.headersObj).sort().map((function(a){return"Authorization"===a&&u?(0,util_1.format)('"%s: %s',a,e.allHeaders.Authorization):(0,util_1.format)('"%s: %s"',a,e.headersObj[a])}));if(e.basicAuth){const{username:a,password:s}=e.basicAuth;d.push(`"Authorization: Basic " . base64_encode("${a}:${s}")`)}r.showBoilerplate&&l.push("/**").push(" * Requires libcurl").push(" */").blank(),(0,code_helpers_1.printUrlVariablesDeclarations)(e,l);let _="";if(Object.keys(e.queryObj||{}).length){const a=(0,utils_2.objectToPhpArray)(e.queryObj||{},{indent:r.indent});_="$query",l.push(`${_} = ${a};`).blank()}if(l.push(`${p} = curl_init();`),l.blank(),e.postData)switch((0,utils_1.normalizeMimeType)(e.postData.mimeType)){case constants_2.MediaTypes.JSON:{const a=(0,utils_2.objectToPhpArray)(e.postData.jsonObj||{},{indent:r.indent});o=!0,i="json_encode($payload)",l.push(`$payload = ${a};`).blank();break}case constants_2.MediaTypes.MULTIPART:{const a=e.postData.params.map((({name:e,value:a})=>`${r.indent}"${e}" => "${a}",\n`)).join("");o=!0,i="$payload",l.push(`$payload = array(\n${a});`).blank();break}case constants_2.MediaTypes.URL_ENCODED:{const a=e.postData.params.map((({name:e,value:a})=>`${e}=${a}`)).join("&");o=!0,i="$payload",l.push(`$payload = "${a}";`).blank();break}default:i=e.postData.text}let b=(0,code_helpers_1.buildUrlExpression)(e,l);_&&(b.endsWith('"')?b=b.slice(0,-1)+`?" . http_build_query(${_})`:b+=` . "?" . http_build_query(${_})`);const $=[{escape:!o,name:"CURLOPT_POSTFIELDS",value:i},{escape:!0,name:"CURLOPT_PORT",value:e.uriObj.port},{escape:!1,name:"CURLOPT_URL",value:b},{escape:!1,name:"CURLOPT_RETURNTRANSFER",value:"true"},{escape:!0,name:"CURLOPT_CUSTOMREQUEST",value:e.method.toUpperCase()}];l.push(`curl_setopt_array(${p}, [`);const m=new code_builder_1.CodeBuilder({indentation:r.indent,lineJoin:`\n${r.indent}`,variablesPrefix:r.variablesPrefix,capitalize:!0,lang:constants_1.Lang.PHP});d.length&&m.push("CURLOPT_HTTPHEADER => [").push(1,d.join(",\n"+r.indent+r.indent)).push("],"),$.forEach((function(e){[null,void 0].includes(e.value)||m.push((0,util_1.format)("%s => %s,",e.name,e.escape?JSON.stringify(e.value):e.value))}));const T=e.cookies.map((function(e){return encodeURIComponent(e.name)+"="+encodeURIComponent(e.value)}));return T.length&&m.push((0,util_1.format)('CURLOPT_COOKIE => "%s",',T.join("; "))),l.push(1,m.join()).push("]);").blank().push(`${c} = curl_exec(${p});`).push(`${h} = curl_error(${p});`).blank().push(`curl_close(${p});`).blank().push(`if (${h}) {`),r.namedErrors?l.push(1,`echo array_flip(get_defined_constants(true)["curl"])[${h}];`):l.push(1,`echo "cURL Error #:" . ${h};`),l.push("} else {").push(1,`echo ${c};`).push("}"),!r.noTags&&r.closingTag&&l.blank().push("?>"),l.join()};exports.info={key:"curl",title:"cURL",link:"http://php.net/manual/en/book.curl.php",description:"PHP with ext-curl"},exports.default=handler;
//# sourceMappingURL=curl.js.map