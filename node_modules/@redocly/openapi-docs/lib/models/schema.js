"use strict";var __rest=this&&this.__rest||function(e,i){var t={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&i.indexOf(r)<0&&(t[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(r=Object.getOwnPropertySymbols(e);n<r.length;n++)i.indexOf(r[n])<0&&Object.prototype.propertyIsEnumerable.call(e,r[n])&&(t[r[n]]=e[r[n]])}return t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getSchema=getSchema;const theme_1=require("@redocly/theme"),config_1=require("@redocly/config"),OpenAPIParser_1=require("../services/OpenAPIParser"),utils_1=require("../utils"),field_1=require("./field");function getSchema({parser:e,schemaOrRef:i,pointer:t,options:r,isChild:n=!1,baseRefsStack:s=[],deps:o,absolutePointer:a}){var l,p,d,c,f,m,u,y,O;const{resolved:h,refsStack:v}=e.deref(i,s,!0),b=i.$ref||t||a||"",g=(0,OpenAPIParser_1.pushRef)(v,b),P=e.mergeAllOf(h,b,g,i.$ref||a),x=P.type||(0,utils_1.detectType)(P),_={operationPointer:(null===(l=o.operation)||void 0===l?void 0:l.pointer)||a||"",schemaOrRef:i,isChild:n,typePrefix:"",pointer:b,absolutePointer:a,refsStack:g,rawSchema:h,type:x,isCircular:!!P["x-circular-ref"],isComplex:!!P["x-complex"],title:P.title||(0,utils_1.isNamedDefinition)(b)&&utils_1.JsonPointer.baseName(b)||"",description:(0,utils_1.getValueFromMdParsedExtension)(P,"description")||"",format:P.format,enum:P.enum||[],example:P.example,deprecated:!!P.deprecated,pattern:P.pattern,externalDocs:P.externalDocs,displayFormat:P.format,isPrimitive:(0,utils_1.isPrimitiveType)(P,x),constraints:(0,utils_1.humanizeConstraints)(P),default:P.default,readOnly:!!P.readOnly,writeOnly:!!P.writeOnly,const:P.const||"",contentEncoding:P.contentEncoding,contentMediaType:P.contentMediaType,minItems:P.minItems,maxItems:P.maxItems,nullable:P.nullable||P["x-nullable"],schema:P,displayType:"",items:void 0,extensions:void 0,oneOfType:"",discriminatorProp:void 0,oneOf:void 0,[config_1.REDOCLY_TEAMS_RBAC]:P[config_1.REDOCLY_TEAMS_RBAC],"x-enumDescriptions":(0,utils_1.getValueFromMdParsedExtension)(P,"x-enumDescriptions"),get fields(){if(!_.isCircular&&!_.isComplex&&(hasType(_,"object")||hasType(_,"array")&&(Array.isArray(P.items)||Array.isArray(P.prefixItems))))return buildFields(e,P,b,r,g,o)}};if((P.nullable||P["x-nullable"])&&(Array.isArray(_.type)&&!_.type.some((e=>null===e||"null"===e))?_.type=[..._.type,"null"]:Array.isArray(_.type)||null===_.type&&"null"===_.type||(_.type=[_.type,"null"])),_.displayType=Array.isArray(_.type)?_.type.map((e=>null===e?"null":e)).join(" or "):_.type,_.isCircular)return _;if(P.if&&P.then||P.if&&P.else){const{oneOf:i,oneOfType:t}=initConditionalOperators({schema:P,parser:e,pointer:b,options:r,deps:o,refsStack:g});return _.oneOf=i,_.oneOfType=t,_}if(!n&&void 0!==getDiscriminator(P)){const{oneOf:i,discriminatorProp:t}=initDiscriminator({schema:P,parser:e,deps:o,mergedSchema:P,options:r,pointer:b,refsStack:g});return _.oneOf=i,_.discriminatorProp=t,_}if(n&&Array.isArray(P.oneOf)&&P.oneOf.find((e=>e.$ref===b))&&delete P.oneOf,void 0!==P.oneOf){const{oneOf:i,displayType:t}=initOneOf({schemaOneOf:P.oneOf,parser:e,deps:o,options:r,pointer:b,refsStack:g,schema:P});return _.oneOfType="One of",i&&(_.oneOf=i),_.displayType=t,void 0!==P.anyOf&&console.warn(`oneOf and anyOf are not supported on the same level. Skipping anyOf at ${b}`),_}if(void 0!==P.anyOf){const{oneOf:i,displayType:t}=initOneOf({schemaOneOf:P.anyOf,parser:e,deps:o,options:r,pointer:b,refsStack:g,schema:P});return i&&(_.oneOf=i),_.displayType=t,_.oneOfType="Any of",_}if(hasType(_,"array")&&(P.items&&(_.items=getSchema({parser:e,schemaOrRef:P.items,pointer:b+"/items",options:r,baseRefsStack:g,deps:o,absolutePointer:utils_1.JsonPointer.join(P.absolutePointer||"",["items"])})),_.displayType=P.prefixItems||Array.isArray(P.items)?"items":(0,utils_1.pluralizeType)((null===(p=_.items)||void 0===p?void 0:p.displayType)||_.displayType),_.displayFormat=(null===(d=_.items)||void 0===d?void 0:d.format)||"",_.typePrefix=(null===(c=_.items)||void 0===c?void 0:c.typePrefix)||"Array of ",_.title=_.title||(null===(f=_.items)||void 0===f?void 0:f.title)||"",_.isPrimitive=void 0!==(null===(m=_.items)||void 0===m?void 0:m.isPrimitive)?null===(u=_.items)||void 0===u?void 0:u.isPrimitive:_.isPrimitive,void 0===_.example&&void 0!==(null===(y=_.items)||void 0===y?void 0:y.example)&&(_.example=[_.items.example]),(null===(O=_.items)||void 0===O?void 0:O.isPrimitive)&&(_.enum=_.items.enum,_["x-enumDescriptions"]=(0,utils_1.getValueFromMdParsedExtension)(_.items,"x-enumDescriptions")),Array.isArray(_.type))){const e=_.type.filter((e=>"array"!==e));e.length&&(_.displayType+=` or ${e.join(" or ")}`)}return r.showExtensions&&(_.extensions=(0,utils_1.extractExtensions)(P,r.showExtensions)),_}function initDiscriminator({schema:e,parser:i,pointer:t,options:r,refsStack:n,deps:s,mergedSchema:o}){const a=getDiscriminator(e),l=null==a?void 0:a.propertyName,p=i.findDerived([...o["x-parentRefs"]||[],t]);if(e.oneOf)for(const i of e.oneOf){if(void 0===i.$ref)continue;const e=utils_1.JsonPointer.baseName(i.$ref);p[i.$ref]=e}const d=(null==a?void 0:a.mapping)||{};let c=(null==a?void 0:a["x-explicitMappingOnly"])||!1;0===Object.keys(d).length&&(c=!1);const f={};for(const e in d){const i=d[e];Array.isArray(f[i])?f[i].push(e):f[i]=[e]}const m=c?Object.assign({},f):Object.assign(Object.assign({},p),f);let u=[];for(const e of Object.keys(m)){const i=m[e];if(Array.isArray(i))for(const t of i)u.push({$ref:e,name:t});else u.push({$ref:e,name:i})}const y=Object.keys(d);0!==y.length&&(u=u.sort(((e,i)=>{const t=y.indexOf(e.name),r=y.indexOf(i.name);return t<0&&r<0?e.name.localeCompare(i.name):t<0?1:r<0?-1:t-r})));return{oneOf:u.map((({$ref:e,name:t},a)=>{const l=getSchema({parser:i,schemaOrRef:{$ref:e},pointer:e,options:r,isChild:!0,baseRefsStack:n.slice(0,-1),deps:Object.assign(Object.assign({},s),{parentFieldFullPath:s.parentFieldFullPath?s.parentFieldFullPath+"&d="+a:"&d="+a.toString()}),absolutePointer:o.absolutePointer});return l.title=t,l})),discriminatorProp:l}}function initOneOf({schemaOneOf:e,parser:i,refsStack:t,pointer:r,schema:n,options:s,deps:o}){const a=e.map(((e,a)=>{const{resolved:l,refsStack:p}=i.deref(e,t,!0),d=i.mergeAllOf(l,r+"/oneOf/"+a,p),c=(0,utils_1.isNamedDefinition)(e.$ref)&&!d.title?utils_1.JsonPointer.baseName(e.$ref):`${d.title||""}${d.const&&JSON.stringify(d.const)||""}`;return getSchema({parser:i,schemaOrRef:Object.assign(Object.assign({},d),{title:c,allOf:[Object.assign(Object.assign({},n),{oneOf:void 0,anyOf:void 0})],discriminator:l.allOf?void 0:d.discriminator}),pointer:e.$ref||r+"/oneOf/"+a,options:s,baseRefsStack:p,deps:Object.assign(Object.assign({},o),{parentFieldFullPath:o.parentFieldFullPath?o.parentFieldFullPath+"&oneOf="+a:"&oneOf="+a.toString()})})})),l=a.map((e=>{let i=e.typePrefix+(e.title?`${e.title} (${e.displayType})`:e.displayType);return i.indexOf(" or ")>-1&&(i=`(${i})`),i})).join(" or ");return{oneOf:a,displayType:l}}function initConditionalOperators({schema:e,parser:i,pointer:t,options:r,refsStack:n,deps:s}){const{if:o,else:a={},then:l={}}=e,p=__rest(e,["if","else","then"]);return{oneOf:[{allOf:[p,l,o],title:o&&o["x-displayName"]||(null==o?void 0:o.title)||"case 1"},{allOf:[p,a],title:a&&a["x-displayName"]||(null==a?void 0:a.title)||"case 2"}].map(((e,o)=>getSchema({parser:i,schemaOrRef:Object.assign({},e),pointer:t+"/oneOf/"+o,options:r,baseRefsStack:n,deps:Object.assign(Object.assign({},s),{parentFieldFullPath:s.parentFieldFullPath?s.parentFieldFullPath+"&oneOf="+o:"&oneOf="+o.toString()})}))),oneOfType:"One of"}}function normalizeField(e,i,t){return e||(console.warn(`Field "${i}" is invalid, skipping.\n Field must be an object but got ${typeof e} at "${t}"`),{})}function buildFields(e,i,t,r,n,s){let o=i.properties||(hasType(i,"array")?i.prefixItems||i.items:void 0)||{};const a=i.patternProperties||{},l=i.additionalProperties||i.unevaluatedProperties,p=i.prefixItems?i.items:i.additionalItems,d=i.default||{};let c=Object.keys(o).map((a=>{var l;const p=normalizeField(o[a],a,t),c=void 0!==i.required&&i.required.indexOf(a)>-1;return(0,field_1.getField)(e,{name:i.properties?a:`[${a}]`,required:c,schema:Object.assign(Object.assign({},p),{example:(null===(l=i.example)||void 0===l?void 0:l[a])||p.example,default:void 0===p.default&&d?d[a]:p.default})},t+"/properties/"+a,r,s,n,utils_1.JsonPointer.join(i.absolutePointer||"",["properties",a]))}));return r.sortRequiredPropsFirst&&(c=(0,utils_1.sortByRequired)(c,i.required)),c.push(...Object.keys(a).map((i=>{const o=normalizeField(a[i],i,t);return(0,field_1.getField)(e,{name:i,required:!1,schema:o,kind:"patternProperties"},`${t}/patternProperties/${i}`,r,s,n)}))),((0,theme_1.isObject)(l)||!0===l)&&c.push((0,field_1.getField)(e,{name:((0,theme_1.isObject)(l)&&l["x-additionalPropertiesName"]||"property name").concat("*"),required:!1,schema:!0===l?{}:l,kind:"additionalProperties"},t+"/additionalProperties",r,s,n,utils_1.JsonPointer.join(i.absolutePointer||"",["additionalProperties"]))),c.push(...buildAdditionalItems({parser:e,schema:p,fieldsCount:c.length,$ref:t,options:r,refsStack:n,deps:s})),(0,utils_1.sortByDeprecated)(c)}function buildAdditionalItems({parser:e,schema:i=!1,fieldsCount:t,$ref:r,options:n,refsStack:s,deps:o}){return"boolean"==typeof i?i?[(0,field_1.getField)(e,{name:`[${t}...]`,schema:{},kind:"additionalItems"},`${r}/additionalItems`,n,o,s)]:[]:Array.isArray(i)?[...i.map(((i,a)=>(0,field_1.getField)(e,{name:`[${t+a}]`,schema:i,kind:"additionalItems"},`${r}/additionalItems/${a}`,n,o,s)))]:(0,theme_1.isObject)(i)?[(0,field_1.getField)(e,{name:`[${t}...]`,schema:i,kind:"additionalItems"},`${r}/additionalItems`,n,o,s)]:[]}function getDiscriminator(e){return e.discriminator||e["x-discriminator"]}function hasType(e,i){return e.type===i||Array.isArray(e.type)&&e.type.includes(i)}
//# sourceMappingURL=schema.js.map