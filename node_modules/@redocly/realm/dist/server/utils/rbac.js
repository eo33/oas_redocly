import l from"path";import h from"picomatch";import"../node-crypto-polyfill.js";import{canExpandConfig as F,expandRbacConfig as L,getTeamFolderDefaults as _,parseTeamFoldersTemplate as I,parseTeamNameTemplate as C}from"./rbac-expand.js";import{DEFAULT_ANONYMOUS_VISITOR_TEAM as T,PUBLIC_ASSETS_FOLDER as N,ServerRoutes as b,REDOCLY_TEAMS_RBAC as x,PUBLIC_RBAC_SCOPE_ITEM as u,PUBLIC_API_DEFINITIONS_FOLDER as y,REDOCLY_ROUTE_RBAC as m}from"../../shared/constants.js";import{getUserParamsFromCookies as B}from"../web-server/auth.js";import{shaDirPathShort as M}from"./crypto.js";import g from"./reporter/logger.js";import{bold as E}from"./reporter/colors.js";import{parsePathVersions as U}from"../plugins/config-parser/loaders/versions-config-loader.js";import{getDeeperGlobPattern as W}from"./globs.js";import{removeTrailingSlash as $}from"../../shared/utils.js";const P=["NONE","READ","TRIAGE","WRITE","MAINTAIN","ADMIN"];function rt(t,e){const n=P.indexOf(t.toUpperCase()),r=P.indexOf(e.toUpperCase());return n>r?t:e}function p(t,e){if(!t||!e)return u;const n=t.content;if(!n)return u;const{slug:r,fsPath:o}=e[m]??{},a=Object.keys(n).filter(f=>r&&h.isMatch(r,f)||o&&h.isMatch(o,f));if(a.length==0)return u;const i=a.map(f=>h.scan(f,{tokens:!0}));let c=i[0];for(let f=1;f<i.length;f++)c=W(c,i[f]);return n[c.input]}function R(t,e={},n={},r=!1){if(t.slug&&typeof t.slug=="string"&&Object.values(b).some(c=>t.slug?.startsWith(c)))return!0;if(r&&Object.keys(n).length===0)return!!e.isAuthenticated;const o=L(n,e.teams||[]),s=t[x]||p(o,t);if(Object.keys(s||{}).length===0)return!1;if(s===u)return!0;const a=(e?.email?[...e?.teams||[],e?.email]:e?.teams)||[],i=[];for(const c of a??[])s[c]?i.push(s[c]):s["*"]&&c!==e?.email&&i.push(s["*"]);return i.length?i.some(c=>c.toLowerCase()!=="none"):!1}function nt(t,e,n,r){if(!t.startsWith(y))return!0;const o=t.replace(new RegExp(`^${y}/`),""),a=o==="."?"":o,i={[m]:{slug:t,fsPath:a},slug:t};return R(i,r,e,n)}function ot(t,e,n,r,o){if(!t.startsWith(N))return!0;const s=t.match(/.*\..{64}\.([A-Fa-f0-9]{8})\.[^\.]+$/)?.[1];if(!s)return!0;const a=r[s];if(!a)return!0;const{base:i,ext:c}=l.parse(t),f=i.split(".")[0],w=c.split(".").join(""),S=a==="."?"":a,j={[m]:{slug:t,fsPath:l.posix.join(S,`${f}.${w}`)},slug:t};return R(j,o,e,n)}async function st(t,e){const{isAuthenticated:n=!1,idpAccessToken:r,...o}=await B(t,e),{teams:s=[]}=o;let a;return n?a=s.filter(i=>i!==T):a=[T],{isAuthenticated:n,idpAccessToken:r,teams:a,claims:o}}function D(t,e,n={},r=!1){if(!t)return t;if(Array.isArray(t))return t.map(o=>D(o,e,n,r)).filter(o=>o!==void 0);if(typeof t=="object"){if(!R(t,e,n,r))return;let o=!1;const s=Object.keys(t).reduce((a,i)=>{if(i===x||i===m)return a;const c=D(t[i],e,n,r);return i==="items"&&Array.isArray(c)&&c.length===0&&t[i].length!==0?(o=!0,a):(c!==void 0&&(a[i]=c),a)},{});return o?void 0:s}return t}function at(t){return typeof t=="string"?t.split(" ").filter(Boolean):Array.isArray(t)?t.map(e=>e.toString()):[]}function it(t,e){if(!e)return;const n=e.content;if(!n)return e;const r=Object.entries(n).flatMap(([s,a])=>s==="**"?[[s,a]]:[[s,a],...t.localeFolders.map(i=>[s.startsWith("/")?`/${i.toLocaleLowerCase()}${s}`:l.posix.join(t.localizationFolder,i,s),a])]),o=Object.fromEntries(r);return{...e,content:o}}async function ct(t,e){if(!e)return{};const n={},r=new Set((await t.scan()).flatMap(({relativePath:o})=>{const{versionFolderPath:s}=U(o)||{},a=l.dirname(o);return s?[s,a]:a}));for(const o of r)n[M(o)]=o;return n}const d=t=>typeof t=="object"&&t!==null&&!Array.isArray(t),Y=t=>{if(t&&d(t)&&("content"in t&&d(t.content)||"reunite"in t&&d(t.reunite)||t.teamFolders&&t.teamNamePatterns)){const e=Object.values(t.content||{});if(e.length===0)return!0;if(e.every(d))return e.every(n=>Object.values(n).every(r=>typeof r=="string"))}return!1},ft=t=>{if(!t)return;if(Object.keys(t).length===0)return{};const e={...t};if(e.cms&&(e.reunite=e.cms,delete e.cms,g.warn(`You are using old format of ${E("rbac:")} configuration that will be deprecated soon. Please rename "cms" to "reunite".`)),Y(t))return O(t);g.warn(`You are using old format of ${E("rbac:")} configuration that will be deprecated soon. Please update it to new format.`);const n=e.defaults;return delete e.defaults,{content:{...n?{"**":n}:{},...O(e)}}},O=t=>{const e={...t};if(e.content){const n={};for(const r in e.content)if(e.content[r]!==void 0){const o=$(r);n[o]=e.content[r]}e.content=n}return e};function lt(t,e){const n=t.fsPath,r=t.slug,o=[];if(F(e)){const s=I(e,[n,r]);if(s){const a=e?.teamNamePatterns?.map(c=>c.replace("{teamPathSegment}",s.teamPathSegment).replace("{projectRole}","read"))??[];o.push(...a);const i=p({content:{..._(e),...e.content}},t);o.push(...A(i))}else{const a=p(e,t);o.push(...A(a))}}else{const s=p(e,t);o.push(...A(s))}return v(e,o)}function A(t){if(!t)return[];const e=[],n="*"in t?{authenticated:t["*"],anonymous:t["*"]}:{};for(const[r,o]of Object.entries({...n,...t}))o!=="none"&&r!=="*"&&e.push(r);return e}function v(t,e){return e.map(r=>C(t,r)??{teamName:r}).map(r=>r.projectRole&&r.projectRole!=="READ"?r.teamName?.toLowerCase().replace(r.projectRole?.toLowerCase?.()??"","read")??"":r.teamName?.toLowerCase()??"")}export{P as PROJECT_ROLES_ORDERED_BY_ACCESS_LEVEL,it as applyL10nToRbacConfig,ot as canAccessAsset,R as canAccessResource,nt as canDownloadApiDefinition,Y as checkIfRbacConfigIsNewFormat,v as expandTeamsForRead,A as extractTeamsForSearch,D as filterDataByAccessDeep,p as getAllowedTeamsForRoute,st as getAuthDetailsFromCookies,rt as getHigherRole,lt as getRbacTeamsForSearch,O as normalizeRbacConfig,ft as parseRbacConfigToNewFormat,at as parseTeamClaimToArray,ct as resolveDirectoryHashes};
