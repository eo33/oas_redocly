import{MARKDOC_PARTIALS_DATA_KEY as A}from"../store.js";import{reporter as O}from"../utils/reporter/reporter.js";import{canAccessResource as q,filterDataByAccessDeep as f}from"../utils/rbac.js";import{render as S}from"./render.js";import{importServerProps as I}from"./utils.js";import{logger as v,readSharedData as L}from"../utils/index.js";import{getLocaleFromPathname as y,withPathPrefix as T}from"../../shared/urls.js";async function k(e,t,a,r){const{teams:i=[],idpAccessToken:o,claims:l}=t?.get("auth")||{},d=Object.fromEntries(t?.req.raw.headers.entries()??[]),p=r.getGlobalData()?.l10n,c={rbac:{teams:i},user:l,headers:d,remoteAddr:t?.req.raw.context.remoteAddr,idpAccessToken:o,lang:y(e.slug,p?.defaultLocale,p?.locales)};if(!e.serverPropsGetterIds?.length){const s=a.props||{};return{...s,variables:{...c,...typeof s.variables=="object"?s.variables:{}}}}const{serverProps:n}=await I(r.serverOutDir),m=await Promise.all(e.serverPropsGetterIds.map(async s=>{const g=n[s];return g||O.panicOnBuild(`Invalid server props getter id: "${s}" for route "${e.slug}"`),await(await g()).default(e,a,{variables:c,partials:r.getGlobalConfig(A)},r.serverOutDir)}));return Object.assign({},...m)}async function x(e,t,a,r){const i=v.startTiming(),o=r.routesSharedData.get(e.slug)||{},{isAuthenticated:l,teams:d,claims:{name:h,picture:p,email:c}}=a?.get("auth")||{claims:{}},n={isAuthenticated:l,email:c,teams:d},m=Object.fromEntries(await Promise.all(Object.entries(o).map(async([G,b])=>[b,await L(b,r.outdir)]))),s=f(m,n,r.config.rbac,r.config.requiresLogin),g=f(r.globalData,n,r.config.rbac,r.config.requiresLogin),u=q(e,n,r.config.rbac,r.config.requiresLogin),w={page:{templateId:e.templateId,slug:T(e.slug),versions:f(e.versions,n,r.config.rbac,r.config.requiresLogin),props:t,sharedDataIds:u?o:{},request:{search:a?.req.raw.context.url?.search||"",url:a?.req.raw.context.url?.href||""},userInfo:{isAuthenticated:l,name:h,picture:p,email:c,teams:d}},store:{globalData:g,cliOptions:r.cliOptions,config:r.config,ssr:r.ssr,hasSitemap:r.hasSitemap},sharedData:u?s:{},serverOutDir:r.serverOutDir,outdir:r.outdir,ssrHref:j(a)};if(r.renderMode==="thread_worker")throw new Error("Unimplemented");const{html:D,statusCode:P}=await S(w);return v.verboseTime(i,`Page rendered ${e.slug}`),{html:D,props:t,statusCode:P}}function j(e){const t=e?.req.raw.url;if(!t)return"";const a=new URL(t),r=e?.req.raw.headers,i=r?.get("x-forwarded-proto")||a.protocol.replace(":",""),o=r?.get("x-forwarded-host")||a.host;return`${i}://${o}`}export{k as getServerProps,x as renderPage};
