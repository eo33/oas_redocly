import{pathToFileURL as $}from"url";import{Helmet as q}from"react-helmet";import{renderToString as c}from"react-dom/server";import{StaticRouterProvider as I,createStaticHandler as N,createStaticRouter as z}from"react-router-dom/server.js";import o from"react";import{readFile as Y}from"fs/promises";import{join as G}from"path";import{reporter as J}from"../utils/reporter/reporter.js";import{slash as K}from"../../shared/utils.js";import{htmlTemplate as Q}from"./template.js";import{compileCustomTemplate as V}from"./custom-template.js";import{detectColorSchemaScript as W,generatePreloadPageData as X}from"./utils.js";import"./hijack-console.js";import{formatSeoTags as Z}from"./format-seo-tags.js";import{getLocaleFromPathname as tt,withPathPrefix as m}from"../../shared/urls.js";import{telemetry as et}from"../../cli/telemetry/index.js";import{RUNTIME_RESOURCES_DIR as R}from"../../shared/constants.js";import{isDevelopMode as rt}from"../utils/is-develop-mode.js";let l="";const ot=`<link rel="stylesheet" href="${m(R)}/browser-entry.css" />`;async function st(t){return process.env.REDOCLY_STATIC_BUNDLE?await import("../../client/server-entry.js"):await import($(`${K(t)}/server-entry.js`)+"?"+new Date)}async function Et(t){const{Loader:p,App:w,routes:y,ServerStyleSheet:D,StyleSheetManager:C,ErrorDetails:E}=await st(t.serverOutDir),{page:g,store:{globalData:f,hasSitemap:B},sharedData:v,ssrHref:P}=t,u=f?.l10n,h=tt(g.slug,u?.defaultLocale,u?.locales),S=t.page.request?.url||"http://localhost/";await p.prepare({...g,slug:new URL(S).pathname},v,f,h);const n=new D,{query:H,dataRoutes:L}=N([{Component:w,path:m("*"),children:y}]),s=await H(new Request(S));if(s instanceof Response)throw s;const _=z(L,s);try{globalThis.SSR_HOSTNAME=P;const e=c(o.createElement(C,{sheet:n.instance},o.createElement(I,{router:_,context:s}))),b=Z({...t.store.config.seo,...t.page.props.seo},B),a=q.renderStatic(),j=a.title.toString(),O=t.store.globalData?.logo?.favicon,d=t.store.cliOptions?.customHtmlTemplate,r=t.store.config,k=`<link rel="preload" as="fetch" crossorigin="anonymous" href="${m("/app-data.json")}" />`,x=X(t.page.slug),M=W(r),U=t.store.ssr.headTags.join(""),A=t.store.ssr.postBodyTags.join(""),F=t.store.ssr.preBodyTags.join("");!rt()&&!l&&(l=`<style>${await Y(G(t.outdir,R,"browser-entry.css"),"utf-8")}</style>`);const T={bodyHtml:e,linkTags:r.linkTags+n.getStyleTags()+a.link.toString(),title:j,favicon:O,headScriptTags:b+M+r.headScriptTags+U+a.script.toString(),preload:[k,x],postBodyScriptTags:r.postBodyScriptTags+A,preBodyScriptTags:r.preBodyScriptTags||""+F,lang:h,runtimeCss:l||ot};let i;return d?i=V(d,T):i=Q(T),{html:i,statusCode:200}}catch(e){return J.panicOnBuild(e),et.send("ssr_error_caught",{message:e.message}),{html:c(o.createElement(E,{error:e})),statusCode:500}}finally{n.seal(),p.clear()}}function Bt(t){return c(o.createElement(o.Fragment,null,t))}export{Et as render,Bt as renderComponents};
