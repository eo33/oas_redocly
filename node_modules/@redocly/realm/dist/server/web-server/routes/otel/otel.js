import{ulid as i}from"ulid";import{getClientIp as v}from"../../utils/get-client-ip.js";import{PRODUCT_NAME as d}from"../../../../config/product-gates.js";import{toAttribute as e}from"./otlp.js";const _=process.env.OTEL_TRACES_URL||"https://otel.cloud.redocly.com/v1/traces";async function h(t){const n=await t.req.json(),s=g(t),r={resourceSpans:n.resourceSpans.map(o=>{const c=o.resource.attributes.find(u=>u.key==="redocly.session.id")?.value.stringValue;return c?{...o,resource:{...o.resource,attributes:[...o.resource.attributes,...p(s,c)]},scopeSpans:o.scopeSpans.map(u=>({...u,spans:u.spans.map(a=>({...a,attributes:a.name.startsWith("event.")?y(a,s,c):a.attributes}))}))}:o})};return await fetch(_,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)}),t.newResponse(null,200,{})}function g(t){const n=t.get("auth")?.claims?.id||t.get("auth")?.claims?.sub,s=v(t.req.raw)||t.req.raw.context.remoteAddr?.hostname,r=t.req.raw.headers.get("user-agent"),o=t.req.raw.headers.get("accept-language"),c=o?.split(",")[0];return{userId:n,clientIp:s,userAgent:r||void 0,acceptLanguage:o||void 0,locale:c}}function p(t,n){const s=[e("redocly.organization.id",process.env.ORGANIZATION_ID),e("redocly.organization.slug",process.env.ORGANIZATION_SLUG),e("redocly.project.id",process.env.PROJECT_ID),e("redocly.project.slug",process.env.PROJECT_SLUG),e("redocly.product.type",d.toLowerCase()),e("redocly.client.ip",t.clientIp),e("redocly.client.userAgent",t.userAgent),e("redocly.client.acceptLanguage",t.acceptLanguage),e("redocly.client.locale",t.locale)];return t.userId?s.push(e("redocly.user.id",t.userId)):s.push(e("redocly.anonymous.id",l(n))),s.filter(r=>r!==void 0)}function y(t,n,s){const r=new Map;t.attributes.forEach(a=>{r.set(a.key,a)});const o=f(n.userId,s),c=new Date(Math.floor(Number(t.startTimeUnixNano)/1e6)).toISOString(),u=[e("cloudevents.event_spec_version","1.0"),e("cloudevents.event_object","event"),e("cloudevents.event_id",`evt_${r.get("redocly.event_id")?.value.stringValue}`),e("cloudevents.event_origin","realm-ui"),e("cloudevents.event_source",o.uri),e("cloudevents.event_source_details.id",o.id),e("cloudevents.event_source_details.object",o.object),e("cloudevents.event_source_details.uri",o.uri),e("cloudevents.event_data_content_type","application/json; charset=utf-8"),e("cloudevents.event_organization_id",process.env.ORGANIZATION_ID),e("cloudevents.event_organization_slug",process.env.ORGANIZATION_SLUG),e("cloudevents.event_project_id",process.env.PROJECT_ID),e("cloudevents.event_project_slug",process.env.PROJECT_SLUG),e("cloudevents.event_product_type",d.toLowerCase()),e("cloudevents.event_session_id",s),e("cloudevents.event_time",c),e("cloudevents.event_client.ip",n.clientIp),e("cloudevents.event_client.user_agent",n.userAgent),e("cloudevents.event_client.accept_language",n.acceptLanguage),e("cloudevents.event_client.locale",n.locale)];switch(r.get("redocly.event_type")?.value.stringValue){case"page.viewed":u.push(e("cloudevents.event_type","page.viewed"),e("cloudevents.event_data.page.object","page"),e("cloudevents.event_data.page.id",r.get("redocly.event_data.uri")?.value.stringValue),e("cloudevents.event_data.page.uri",r.get("redocly.event_data.uri")?.value.stringValue),e("cloudevents.event_data.page.referrer",r.get("redocly.event_data.referrer")?.value.stringValue),e("cloudevents.event_data.page.initial_referrer",r.get("redocly.page.initial_referrer")?.value.stringValue));break;case"error":const a=`err_${i()}`;u.push(e("cloudevents.event_type","error"),e("cloudevents.event_data.error.object","error"),e("cloudevents.event_data.error.id",a),e("cloudevents.event_data.error.uri",`urn:error:ulid:${a}`),e("cloudevents.event_data.error.handler",r.get("redocly.event_data.handler")?.value.stringValue),e("cloudevents.event_data.error.type",r.get("redocly.event_data.type")?.value.stringValue),e("cloudevents.event_data.error.message",r.get("redocly.event_data.message")?.value.stringValue),e("cloudevents.event_data.error.stack",r.get("redocly.event_data.stack")?.value.stringValue),e("cloudevents.event_data.page.object","page"),e("cloudevents.event_data.page.id",r.get("redocly.page.uri")?.value.stringValue),e("cloudevents.event_data.page.uri",r.get("redocly.page.uri")?.value.stringValue),e("cloudevents.event_data.page.initial_referrer",r.get("redocly.page.initial_referrer")?.value.stringValue));break;default:throw new Error(`Unknown event type: ${r.get("redocly.event_type")}`)}return u.filter(a=>a!==void 0)}function f(t,n){return t?{id:t,object:"user",uri:`${process.env.MAIN_API_URL}/users/${t}`}:{id:l(n),object:"anonymous",uri:`${process.env.MAIN_API_URL}/anonymous/${l(n)}`}}function l(t){return t.replace("ses_","ann_")}export{h as otelTracesHandler};
