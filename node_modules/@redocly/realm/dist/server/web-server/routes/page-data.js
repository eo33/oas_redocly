import{canAccessResource as E,filterDataByAccessDeep as L}from"../../utils/rbac.js";import{getServerProps as T}from"../../ssr/index.js";import{DEV_LOGIN_SLUG as U,ServerRoutes as $}from"../../../shared/constants.js";import{findInIterable as y}from"../../../shared/jsUtils.js";import{readSharedData as O}from"../../utils/index.js";import{CACHE_CONTROL_NO_CACHE_HEADER_VALUE as n,DEFAULT_TITLE as F}from"../../constants.js";import{getRedirectLoginUrl as N}from"../utils/get-redirect-login-url.js";import{removeTrailingSlash as P}from"../../../shared/utils.js";function z(e,a){return async(t,p)=>{const l=t.get("logger"),{req:u}=t,{pathname:c}=new URL(u.url),{seo:h,ssoDirect:f}=e.getConfig(),s=h?.title||F,g=c.match(/page-data(.*)data.json$/);if(!g)return p();const i=decodeURI(g[1]),d=i==="/index/"?"/":P(i),o=e.getRouteBySlug(d,{followRedirect:!1})||y(e.routesBySlug.values(),r=>r.hasClientRoutes&&i.startsWith(r.slug));if(i===$.OIDC_CALLBACK+"/")return t.json({templateId:"403OIDC",sharedDataIds:{},props:{seo:{title:`${s} - Forbidden`}}},200,{"Cache-Control":n});const{isAuthenticated:C,teams:D,claims:{name:A,picture:S,email:I}}=t.get("auth"),R={isAuthenticated:C,email:I,teams:D},m={isAuthenticated:C,name:A,picture:S,email:I,teams:D};if(!o){const r=e.getRouteBySlug(d,{followRedirect:!0});return l.error(`Page not found: ${c}`),t.json({templateId:"404",redirectTo:r?.slug,sharedDataIds:{},props:{seo:{title:`${s} - Not Found`}},userData:m},404,{"Cache-Control":n})}if(l.verbose(`Page viewed: ${o.slug}`),!E(o,R,e.config.rbac,e.config.requiresLogin)&&o.slug!==U){if(C)return t.json({templateId:"403",sharedDataIds:{},props:{seo:{title:`${s} - Forbidden`}},userData:m},403,{"Cache-Control":n});const r=Object.keys(f||{}).length>0;return t.json({templateId:"404",sharedDataIds:{},props:{seo:{title:`${s} - Not Found`}},userData:m,...r?{redirectTo:N(e,o.slug)}:{}},r?401:404,{"Cache-Control":n})}const j=L(o.versions,R,e.config.rbac,e.config.requiresLogin),_=e.routesSharedData.get(o.slug)||{},b=await a(o),v=await T(o,t,b,e),w={templateId:o.templateId,versions:j,sharedDataIds:_,props:v,slug:o.slug,userData:m};return t.json(w,200,{"Cache-Control":n})}}function J(e){return async(a,t)=>{const p=a.get("logger"),{req:l}=a,{pathname:u}=new URL(l.url),c=u.match(/\/page-data\/shared\/(.*)\.json/);if(!c)return t();const h=decodeURIComponent(c[1]),f=await O(h,e.outdir),{isAuthenticated:s,teams:g,claims:{email:i}}=a.get("auth"),d=L(f,{isAuthenticated:s,email:i,teams:g},e.config.rbac,e.config.requiresLogin);return d?a.json(d,200,{"Cache-Control":n}):(p.error(`Shared data not found: ${u}`),a.text("Not Found",404,{"Cache-Control":n}))}}export{z as pageDataHandler,J as sharedPageDataHandler};
