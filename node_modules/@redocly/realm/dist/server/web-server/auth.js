import"../node-crypto-polyfill.js";import{DOMParser as C}from"@xmldom/xmldom";import{xpath as c,SignedXml as $,InMemKeyInfo as B}from"@redocly/xml-crypto";import{deflateSync as F,inflateSync as J}from"fflate";import{createHash as q}from"crypto";import{appendQueryParams as z}from"../../shared/urls.js";import{DEFAULT_AUTHENTICATED_TEAM as H,REQUIRED_OIDC_SCOPES as U,ServerRoutes as O}from"../../shared/constants.js";import{AlgorithmTypes as K,JwtTokenExpired as W}from"./jwt/types.js";import*as A from"./jwt/jwt.js";import{AuthProviderType as u}from"../../shared/types/global-data.js";import{parseTeamClaimToArray as Q,randomString as X,randomUUID as P}from"../utils/index.js";import{arrayBufferToBase64 as Y,decodeBase64 as D,encodeBase64URL as G,urlSafeBase64 as T}from"./jwt/encode.js";import{AUTH_URL as Z,JWT_SECRET_KEY as ee}from"../constants.js";import{getPathPrefix as te}from"../../shared/utils.js";function b(e){return e?.type===u.OIDC}function ne(e){return e?.type===u.SAML2}async function De(e,t){if(b(t))return ae(e,t);if(ne(t))return oe(e,t)}async function ae(e,t){const a=await j(e,t),o=new Set((t.scopes||[]).concat(U)),n=t.authorizationRequestCustomParams||{};return{type:u.OIDC,idpId:e,name:"OAuth provider",authorizationEndpoint:a.authorization_endpoint,clientId:t.clientId,responseType:"code",scope:Array.from(o).join(" "),extraParams:n,pkce:t.pkce}}function oe(e,t){return{type:u.SAML2,idpId:e,name:"SAML2 provider",ssoUrl:t.ssoUrl,issuerId:t.issuerId,entityId:t.entityId||t.issuerId}}async function Te(e,t,a,o,n={}){const r=new Set((o.scopes||[]).concat(U));return await fetch(e,{method:"POST",body:new URLSearchParams({client_id:o.clientId,scope:Array.from(r).join(" "),code:t,redirect_uri:R(a),grant_type:"authorization_code",...o.clientSecret?{client_secret:o.clientSecret}:{},...n}).toString(),headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"}}).then(s=>s.json())}function re(e,{authorizationEndpoint:t,clientId:a,responseType:o,scope:n,extraParams:r,idpId:s,pkce:l},m){if(!t||!a||!o||!n)return{loginUrl:void 0};const i=new URL(t),y=`${e}${O.OIDC_CALLBACK}`,w={state:P(),idpId:s,redirectUri:y,redirectTo:m,branch:se(e)},p={};if(l){const d=T(X(50)),h=T(q("sha256").update(d).digest("base64")),S="S256";i.searchParams.append("code_challenge",h),i.searchParams.append("code_challenge_method",S),p.code_verifier={value:d,options:{secure:!0,httpOnly:!0,expires:new Date(Date.now()+1e3*60*10),path:te()||"/"}}}i.searchParams.append("client_id",a),i.searchParams.append("scope",n),i.searchParams.append("response_type",o),i.searchParams.append("redirect_uri",R(y)),i.searchParams.append("state",G(JSON.stringify(w)));for(const d in r)r[d]!==void 0&&i.searchParams.append(d,r[d]);return{loginUrl:i.toString(),cookies:p}}function be(e,t,a,o){const n=new URL(e);return n.searchParams.append("post_logout_redirect_uri",t),o&&n.searchParams.append("state",o),n.searchParams.append("id_token_hint",a),n.toString()}function R(e){return e.match(/^https:\/\/preview-[^\.]+--/)?"https://previewauth--"+e.split("--")[1]:e.match(/^(https:\/\/[^\.]+)--[^\.]+\.preview\./)?e.replace(/^(https:\/\/[^\.]+)--[^\.]+\.preview\./,"$1.previewauth."):e}function se(e){return e.match(/^(https:\/\/[^\.]+)--([^\.]+)\.preview\./)?.[2]||void 0}function ie(e){return e.type===u.OIDC}function ce(e){return e.type===u.SAML2}function Re(e,t,a){return ie(e)?re(t,e,a):ce(e)?ue(t,e,a):{}}function ue(e,t,a){const n=`<samlp:AuthnRequest xmlns:samlp="urn:oasis:names:tc:SAML:2.0:protocol"
    xmlns:saml="urn:oasis:names:tc:SAML:2.0:assertion"
    Version="2.0"
    ID="_${P()}"
    IssueInstant="${new Date().toISOString()}"
    AssertionConsumerServiceURL="${e}${O.SAML_CALLBACK}"
    AttributeConsumingServiceIndex="0">
    <saml:Issuer>${t.entityId}</saml:Issuer>
    <samlp:NameIDPolicy
      AllowCreate="true"
      Format="urn:oasis:names:tc:SAML:2.0:nameid-format:persistent"/>
  </samlp:AuthnRequest>`,r=de(n);return{loginUrl:z(t.ssoUrl,{SAMLRequest:r,RelayState:JSON.stringify({idpId:t.idpId,redirectTo:a})})}}function de(e){return Y(F(new TextEncoder().encode(e)).buffer)}function je(e){const t=D(e);if(t.startsWith("<samlp:Response")||t.indexOf("<saml2p:Response")>-1)return t;const a=J(new Uint8Array(atob(e).split("").map(o=>o.charCodeAt(0))));return new TextDecoder().decode(a)}function Ne(e){try{return JSON.parse(D(e||""))}catch{throw new Error("Invalid OAuth2 state")}}function ve(e){const t=new C().parseFromString(e,"application/xml"),o=c(t,"//*[local-name(.)='StatusCode']/@Value")[0]?.nodeValue.endsWith("Success")||!1,r=c(t,"//*[local-name(.)='Response']/@Destination")[0]?.nodeValue||"",s=c(t,"//*[local-name(.)='Assertion']//*[local-name(.)='Issuer']/text()")[0],l=s&&s.nodeValue||void 0,m=c(t,"//*[local-name(.)='Audience']/text()")[0],i=m&&m.nodeValue||void 0,w=c(t,"//*[local-name(.)='Assertion']//*[local-name(.)='X509Certificate']/text()")[0]?.nodeValue||"",p=c(t,"//*[local-name(.)='Subject']//*[local-name(.)='NameID']/text()")[0],d=p&&p.nodeValue||"",h=c(t,"//*[local-name(.)='Subject']//*[local-name(.)='NameID']/@Format")[0],S=h&&h.nodeValue||"",V=c(t,"//*[local-name(.)='Conditions']/@NotOnOrAfter")[0],E=me(V),I={},L=c(t,"//*[local-name(.)='AttributeStatement']//*[local-name(.)='Attribute']");if(L.length)for(const _ of L){const k=c(_,"./@Name")[0];if(k.nodeValue){const M=c(_,"./*[local-name(.)='AttributeValue']/text()")[0];I[k.nodeValue]=M&&M.nodeValue}}return{uid:d,success:o,expiresAt:E,issuerId:l,entityId:i,attrs:I,cert:w,nameFormat:S,destination:r}}function me(e){const t=typeof e?.nodeValue=="string"&&g(Date.parse(e.nodeValue)),a=g(Date.now()),o=g(Date.now()+12*60*60*1e3);return t?t>a&&t<o?o:t:a}function g(e){return Math.floor(e/1e3)}const x={},f={jwks:{}};async function j(e,t){return x[e]||(x[e]=t.configurationUrl?await N(t.configurationUrl):t.configuration),x[e]}async function le(e){for(const t of Object.keys(e)){const a=e[t];if(!b(a))continue;const o=await j(t,a);if(o.jwks_uri){const n=await N(o.jwks_uri);for(const r of n.keys)f.jwks[r.kid]={...r,idpId:t}}}}async function N(e){return fetch(e,{headers:{Accept:"application/json"}}).then(t=>t.json())}async function Ve(e){return fetch(`${Z}/oidc/userinfo`,{headers:{Accept:"application/json",Authorization:`Bearer ${e}`}}).then(t=>t.status===200?t.json():void 0).catch(()=>{})}function Ee(e){if(!e.configurationUrl)return!1;const t=new URL(e.configurationUrl);return["localhost","127.0.0.1","blueharvest.cloud","bhstage.cloud","cloud.redocly.com","beta.redocly.com","cloud.eu.redocly.com","beta.eu.redocly.com","cba.au.redocly.com"].some(o=>pe(t.hostname,o))}function pe(e,t){return e===t||e.endsWith(`.${t}`)}async function $e(e,t){const a=new C().parseFromString(e),o=c(a,"//*[local-name(.)='Signature' and namespace-uri(.)='http://www.w3.org/2000/09/xmldsig#']")[0];if(!o)throw new Error("Cannot find Signature in the SAML response");const n=new $;return n.keyInfoProvider=new B(t),n.loadSignature(o),n.checkSignature(e)}function Be(e,t,a,o){t==="urn:oasis:names:tc:SAML:2.0:nameid-format:transient"&&(e=a["http://schemas.microsoft.com/identity/claims/objectidentifier"]);let n;(t==="urn:oasis:names:tc:SAML:2.0:nameid-format:email"||t==="urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress")&&(n=e),t==="urn:oasis:names:tc:SAML:2.0:nameid-format:persistent"&&e?.match(/.+@.+/)&&(n=e);const r=a["http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name"],s=r?.match(/.+@.+/);return n=n||a["http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress"]||(s?r:void 0),n=n?.toLowerCase(),{sub:e,given_name:a["http://schemas.xmlsoap.org/ws/2005/05/identity/claims/givenname"],family_name:a["http://schemas.xmlsoap.org/ws/2005/05/identity/claims/surname"],name:a["http://schemas.microsoft.com/identity/claims/displayname"]||r,email:n,email_verified:!0,teams:o?Q(a[o]):[]}}function v(e,t={}){return e.map(a=>t[a]||a)}function fe(e){return e.split(";").map(t=>t.split("=")).reduce((t,a)=>(t.set(decodeURIComponent(a[0].trim()),decodeURIComponent(a[1]?.trim()||"")),t),new Map)}async function Fe(e,t){if(!t)return{};const a=fe(t),o=a.get("authorization");if(!o)return{};try{const n=A.decode(o);if(n.header.alg===K.RS256){f.jwks[n.header.kid]===void 0&&await le(e);const i=f.jwks[n.header.kid];if(!i)return f.jwks[n.header.kid]=null,{};await A.verify(o,i,n.header.alg)}else await A.verify(o,ee,n.header.alg);const r=n.payload.idpId||f.jwks[n.header.kid]?.idpId,s=e[r]||{},l=we(s),m=ye(s);return{...n.payload,email:n.payload.email?.toLowerCase(),idpId:r,teams:[...v(n.payload.teams||[],m),..."defaultTeams"in s&&s.defaultTeams||[],...v("teamsClaimName"in s&&n.payload[l||""]||[],m),H],name:he(n.payload),isAuthenticated:!0,idpAccessToken:a.get("idp_access_token"),authCookie:o}}catch(n){n instanceof W||console.error(n)}return{}}function he(e){return e.name||e.given_name||e.email}function ye(e){switch(e.type){case u.SAML2:return e.teamsAttributeMap;case u.OIDC:return e.teamsClaimMap;default:return}}function we(e){switch(e.type){case u.SAML2:return e.teamsAttributeName;case u.OIDC:return e.teamsClaimName;default:return}}export{Re as buildLoginUrl,re as buildOidcLoginUrl,be as buildOidcLogoutUrl,ue as buildSAML2LoginUrl,je as decodeSamlResponse,de as encodeSAML2,Be as extractUserClaims,De as getAuthProviderLoginParams,ae as getOidcLoginParams,j as getOidcMetadata,Ve as getRedoclyTokenPayload,oe as getSaml2LoginParams,Fe as getUserParamsFromCookies,he as getUsernameFromPayload,b as isOidcProviderConfig,Ee as isRedoclySso,ne as isSaml2ProviderConfig,Te as oidcExchangeCodeForToken,fe as parseCookieHeader,Ne as parseOidcState,se as parsePreviewBranch,ve as parseSamlResponse,R as rewritePreviewAuthRedirectUri,$e as verifySAMLResponse};
