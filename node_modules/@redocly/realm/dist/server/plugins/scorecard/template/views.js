import*as e from"react";import{useCallback as _,useMemo as g,useState as q,useEffect as K}from"react";import{useLocation as x}from"react-router-dom";import{Flex as U}from"@redocly/portal-legacy-ui";import{Button as S}from"@redocly/theme/components/Button/Button";import{AddIcon as T}from"@redocly/theme/icons/AddIcon/AddIcon";import{SubtractIcon as H}from"@redocly/theme/icons/SubtractIcon/SubtractIcon";import{ArrowLeftIcon as k}from"@redocly/theme/icons/ArrowLeftIcon/ArrowLeftIcon";import{getScorecardColorVariable as D}from"@redocly/theme/core/utils";import{Link as L}from"@portal/Link";import Z from"@portal/CircularProgress";import{StatusByLevelWidget as J}from"./StatusByLevelWidget";import{formatLevel as Q,OTHER_TEAMS_LABEL as X,NON_CONFORMANT as Y,getProblemsByRule as ee}from"./utils";import{AppPageWrapper as I,CardValue as w,CardsWrapper as B,CatalogDescription as te,ModeSwitcherTab as re,ModeSwitcherTabs as ne,CardRow as O,ProblemsByStatusCardBody as j,ScoreCardStatusCardBody as V,TableWrap as le,GroupTh as W,LevelComplianceCardTitle as ae,ContentWithDotWrap as y,ScorecardCard as v,ScorecardCardTitle as P}from"./index.styles";import{ApiLevel as F,InstanceStatus as R,LevelStatus as M,renderRowSubComponent as $,RuleStatus as z}from"./components";import A from"./table";import{isDefined as G}from"../../../../shared/jsUtils";import{fetchDetailedScorecard as se,useDetailedScorecard as oe}from"./useDetailedScorecard";import{Gauge as ce,GaugeValue as ie}from"./Gauge";function Te(p){const d=x(),{data:c,levelNames:a,hasPublishedAt:t,hasTeam:o,teamLabel:n}=p,E=_((s,i,r)=>{const m=s.values[r]?new Date(s.values[r]).getTime():0,l=i.values[r]?new Date(i.values[r]).getTime():0;return m>l?1:-1},[]),u=g(()=>[{id:"title",Header:"API",accessor:"api.title",width:"25%",Cell:({value:s,row:{original:i}})=>e.createElement(L,{to:d.pathname+"?api="+encodeURIComponent(i.api.link)},s)},t?{Header:"Published at",accessor:"api.publishedAt",sortType:E,Cell:({value:s})=>s?new Date(s).toLocaleDateString():"-"}:void 0,o?{Header:n,accessor:"api.team"}:void 0,{id:"level",Header:"Level",accessor:"scorecard.scorecardLevel",Cell:({value:s,row:{original:i}})=>e.createElement(F,{level:s,colorVariable:D(i?.scorecard.scorecardLevelIdx,a.length+1)})},...a.map(s=>({id:s,Header:`${s}`,accessor:"scorecard.levels",Cell:({value:i})=>i?.[s]?Q(i?.[s]):null}))].filter(G),[E,a,d.pathname,t,o,n]);return e.createElement(A,{columns:u,data:c,sortBy:[{id:"title",desc:!1}]})}function He(p){const d=x(),{data:c}=p,a=g(()=>[{Header:"Rules",accessor:"ruleId",width:void 0,Cell:({value:t})=>e.createElement(L,{to:d.pathname+"?ruleId="+encodeURIComponent(t)},t)},{id:"status",Header:"Status",accessor:"status",width:200,Cell:({row:{original:t}})=>e.createElement(z,{errors:t.errorApisCount,warnings:t.warningApisCount})},{Header:"Problem APIs",width:200,accessor:"apis",Cell:({value:t})=>t.length,sortDescFirst:!0},{Header:"Problem count",width:200,accessor:"count",sortDescFirst:!0}],[d.pathname]);return e.createElement(A,{columns:a,data:c,sortBy:[{id:"status",desc:!0}]})}function ke(p){const{data:d,levelNames:c,filters:a,setActiveTab:t,teamLabel:o,teamProperty:n}=p,E=g(()=>[{id:"team",Header:`API ${o}`,accessor:"team",width:"25%",Cell:({value:u})=>e.createElement("a",{href:"#",onClick:s=>{s.preventDefault(),t("apis"),a.find(i=>i.property===n)?.selectOption(u)}},u)},...[Y,...c].map(u=>({id:u,Header:`${u}`,accessor:`levels.${u}.apis`}))],[a,c,t,o,n]);return e.createElement(A,{columns:E,data:d,sortBy:[{id:"team",desc:!1}],headGroup:e.createElement("tr",null,e.createElement(W,{style:{width:"25%"}}),e.createElement(W,{colSpan:c.length+1},e.createElement("span",null,"APIs by level")))})}function ue(p){const{data:d,title:c}=p,a=g(()=>[{id:"expand",maxWidth:40,width:40,Header:()=>null,disableSortBy:!0,Cell:({row:t})=>t.canExpand?e.createElement(S,{...t.getToggleRowExpandedProps(),variant:"text",size:"medium",icon:t.isExpanded?e.createElement(H,null):e.createElement(T,null)}):null},{Header:"Rules",accessor:"ruleId",width:void 0,Cell:({value:t,row:o})=>o.canExpand?e.createElement("span",{...o.getToggleRowExpandedProps()},t):null},{Header:"Status",accessor:"status",width:200,Cell:({value:t})=>e.createElement(z,{errors:t?.errorsCount,warnings:t?.warningsCount}),disableSortBy:!0},{Header:"Problem count",accessor:"problemsCount",width:200,sortDescFirst:!0}],[]);return e.createElement(A,{columns:a,data:d,sortBy:[{id:"ruleId",desc:!1}],empty:e.createElement(e.Fragment,null,"\u2705 This API is compliant with ",e.createElement("strong",null,c)," level rules"),renderRowSubComponent:$,subRowKey:"problems"})}function De(p){const d=x(),{slug:c,data:a,totalApis:t,hasTeam:o,hasPublishedAt:n,teamLabel:E}=p,{apis:u}=a,s=g(()=>[{id:"expand",maxWidth:40,width:40,Header:()=>null,disableSortBy:!0,Cell:({row:r})=>r.canExpand?e.createElement(S,{...r.getToggleRowExpandedProps(),variant:"text",size:"medium",icon:r.isExpanded?e.createElement(H,null):e.createElement(T,null)}):null},{Header:"API",accessor:"title",width:void 0},n?{Header:"Published at",width:void 0,accessor:"publishedAt",Cell:({value:r})=>r?new Date(r).toLocaleDateString():"-"}:void 0,o?{Header:E,width:void 0,accessor:"team",Cell:({value:r})=>r||X}:void 0,{Header:"Problem count",width:200,accessor:"count",Cell:({value:r})=>r||0,sortDescFirst:!0}].filter(G),[o,n,E]),i=g(()=>Object.entries(a.teams).sort((r,m)=>m[1]-r[1]),[a.teams]);return e.createElement(I,null,e.createElement(S,{icon:e.createElement(k,null),iconPosition:"left",variant:"ghost",size:"large",to:d.pathname},"Back to dashboard"),e.createElement("h1",null,"Rule ",c),e.createElement(B,null,e.createElement(v,null,e.createElement(P,null,"Rule status"),e.createElement(V,null,e.createElement("div",null,e.createElement(w,null,t),e.createElement("br",null),"APIs"),e.createElement("div",null,e.createElement(y,null,e.createElement(w,{style:{width:"40px",textAlign:"right"}},t-a.warningApisCount-a.errorApisCount),e.createElement(R,{severity:"Pass"})),e.createElement(y,null,e.createElement(w,{style:{width:"40px",textAlign:"right"}},a.warningApisCount),e.createElement(R,{severity:"Warn"})),e.createElement(y,null,e.createElement(w,{style:{width:"40px",textAlign:"right"}},a.errorApisCount),e.createElement(R,{severity:"Error"}))))),e.createElement(v,null,e.createElement(P,null,"Problems by level"),e.createElement(j,null,Object.entries(a.levels).map(([r,m])=>e.createElement(O,{key:r},e.createElement("span",null,r),e.createElement(ce,{chunks:[{share:m.errors/a.count*100,colorVariable:"--scorecard-color-error"},{share:m.warnings/a.count*100,colorVariable:"--scorecard-color-warning"}]}),e.createElement(ie,null,m.errors+m.warnings))))),e.createElement(v,null,e.createElement(P,null,`Problems by ${E}`),e.createElement(j,null,i.slice(0,4).map(([r,m])=>e.createElement(O,{key:r},e.createElement("span",{style:{flex:1,textAlign:"left"}},r),e.createElement(w,null,m)))))),e.createElement(A,{columns:s,data:u,sortBy:[{id:"title",desc:!1}],renderRowSubComponent:$,subRowKey:"problems",getSubRows:r=>se(r.link).then(m=>ee(m,c))}))}function Ie(p){const d=x(),{slug:c,api:a,teamLabel:t}=p,{api:o}=a||{},{scorecard:n,isLoading:E}=oe(c),u=n?.levels||{},[s,i]=q(Object.keys(u)[0]),r=g(()=>o?.publishedAt instanceof Date?o?.publishedAt.toLocaleDateString():o?.publishedAt,[o]);K(()=>{if(n){const l=n.levels||{};i(Object.keys(l)[0])}},[n]);const m=g(()=>{if(!n?.levels)return{};const l={};for(const f of Object.keys(n.levels)){const N=n.levels[f].problems.reduce((C,h)=>(C[h.ruleId]||(C[h.ruleId]=[]),C[h.ruleId].push(h),C),{});l[f]=Object.entries(N).map(([C,h])=>({ruleId:C,problems:[...h.filter(b=>b.severity==="error"),...h.filter(b=>b.severity==="warn")],problemsCount:h.length,status:{errorsCount:h.filter(b=>b.severity==="error").length,warningsCount:h.filter(b=>b.severity==="warn").length}}))}return l},[n?.levels]);return E?e.createElement(U,{justifyContent:"center",mt:"2em"},e.createElement(Z,null)):n?e.createElement(I,null,e.createElement(S,{icon:e.createElement(k,null),iconPosition:"left",variant:"ghost",size:"large",to:d.pathname},"Back to dashboard"),e.createElement("h1",null,o?.title||c),e.createElement(te,null,r&&e.createElement(e.Fragment,null,"Published at: ",new Date().toLocaleString(void 0,{timeZoneName:"short"}),e.createElement("br",null)),e.createElement(L,{to:c,external:!0},"Documentation")),e.createElement(B,null,e.createElement(v,null,e.createElement(ae,null,e.createElement("span",null,"Scorecard level"),e.createElement(F,{level:n.scorecardLevel,colorVariable:D(n.scorecardLevelIdx,Object.keys(u).length)})),e.createElement(V,null,e.createElement("div",null,"Compliance by level"),e.createElement("div",null,Object.entries(n.levels).map(([l,f])=>e.createElement(y,{key:l},e.createElement(w,{style:{width:"100px",textAlign:"right"}},l),e.createElement(M,{errors:f.errors,warnings:f.warnings})))))),e.createElement(J,{title:"Rules compliance",levels:Object.entries(n.levels).map(([l,f])=>({errors:f.uniqueErrors,warnings:f.uniqueWarnings,total:p.rulesPerLevel[l].length,name:l}))}),e.createElement(v,null,e.createElement(P,null,t),e.createElement(w,{style:{fontWeight:"normal"}},o?.team))),e.createElement(ne,{style:{justifyContent:"flex-start"}},Object.keys(n.levels).map(l=>e.createElement(re,{key:l,isActive:s===l,onClick:()=>i(l)},e.createElement(y,null,e.createElement("span",null,l)," ",e.createElement(M,{errors:n.levels[l].errors,warnings:n.levels[l].warnings}))))),Object.keys(u).map(l=>e.createElement(le,{key:l,isActive:s===l},e.createElement(ue,{title:l,data:m[l]})))):e.createElement("div",null,"Scorecard not found")}export{Te as ApiListView,Ie as ApiPage,ue as ApiView,De as RuleView,He as RulesView,ke as TeamsView};
