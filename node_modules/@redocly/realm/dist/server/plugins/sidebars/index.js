import{writeFileSync as X}from"node:fs";import*as d from"path";import Y from"@markdoc/markdoc";import{collectItemsLinkedToSidebars as q,resolveItems as W}from"../nav-utils.js";import{collectPropValueDeep as T,findDeepFirst as _,isDefined as V,partition as Q}from"../../../shared/jsUtils.js";import{logger as M,readEnvVariable as ee,reporter as D}from"../../utils/index.js";import{withoutHash as te}from"../../../shared/urls.js";import{DEFAULT_LOCALE_PLACEHOLDER as C,SIDEBAR_PREFIX as ae}from"../../../shared/constants.js";import{isLocalLink as re,normalizeRouteSlug as G,slash as oe}from"../../../shared/utils.js";import{getInnerText as ie}from"../../../shared/markdoc.js";import{getSidebarReferences as se,hasCircularDependency as ne}from"./utils.js";import{CATALOG_OUTPUT_FILE_NAME as le}from"../../constants.js";import{getLocaleFromRelativePath as ce}from"../../fs/utils/get-locale-from-relative-path.js";import{parsePathVersions as fe}from"../config-parser/loaders/versions-config-loader.js";async function Le({contentDir:u}){return{id:"sidebars",async afterRoutesCreated(r,n){const{cache:c,fs:l}=n,y=r.getConfig(),v=new Map,S=new Set,x=[C,...l.localeFolders],$=new Map;let A=(await l.scan(/sidebars.yaml$/)).map(({relativePath:e})=>e).filter(e=>!ge(y.ignore??[],e)&&e);const j=await se(n,u,A),K=Q(A.filter(e=>!j.has(e)),e=>fe(e)?.versionFolderPath||e),Z=await q(y?.navbar,r,n);let P;const E=ne(j);E&&Array.isArray(E)&&D.panicOnBuildContentError(`Sidebar references have circular dependency. Please check your sidebar files.
            Circular dependency chain: ${E.reverse().join(" -> ")}
          `);for(const e of K){const f=(await Promise.all(e.map(async t=>{const i=(await c.load(t,"yaml")).data;if(!Array.isArray(i)){D.panicOnBuildContentError('Invalid sidebar contents at %sp, items should be an array, got "%s"',t,typeof i);return}return{items:i,sidebarRelativePath:t,locale:ce(t)}}))).filter(V),a=(await R(f))?.firstLink;P||(P=a)}const B=Object.entries(y?.catalog??{});for(const e of x){for(const[t,i]of B)await z(t,i,e);const f={},a=new Set;for(const t of r.getAllRoutesForLocale(e).values())if(S.has(t.slug)&&t.fsPath&&!a.has(t.fsPath)){a.add(t.fsPath);let o=d.posix.dirname(t.fsPath);const g=d.parse(o).root;do f[o]=(f[o]||0)+1,o=d.dirname(o);while(o&&o!="."&&g!=o)}for(const t of r.getAllRoutesForLocale(e).values()){if(v.has(t.slug))continue;const i=S.has(t.slug),o=d.dirname(t.fsPath),g=f[o]===1,b=(t.baseSlug||t.slug).replaceAll("/","_");i&&g?await R([{items:[{directory:o}],sidebarRelativePath:"sidebar.yaml_"+b,locale:e}]):t.getSidebar!==void 0&&await R([{items:[{page:t.fsPath}],sidebarRelativePath:"sidebar.yaml_"+b,locale:e}])}for(const[t,i]of B)await z(t,i,e,!0)}if(A.length===0)for(const e of x){M.verbose("Creating default sidebar");const f=e===C,a=`sidebars.yaml${f?"":"_"+e}`,t=f?"":`${l.localizationFolder}/${e}`,i=(await R([{items:[{directory:`./${t}`}],sidebarRelativePath:a,locale:e,ignoredRoutes:S}]))?.firstLink;P||(P=i)}if(!r.getRouteBySlug("/")){const e=r.getAllRoutes(),f=P?P.link:e.length?e[0].baseSlug:null;if(f){const a=te(f);r.addRedirect("/",{to:a,type:302}),M.info("Creating default redirect for index page => %s",a)}}const N=ee("REDOCLY_METADATA_OUTPUT_FOLDER");N&&(M.info("Writing catalog data..."),X(d.join(N,le),JSON.stringify(Object.fromEntries($.entries()))));async function R(e){if(e.length===0)return;const a=(await Promise.all(e.map(async({items:g,locale:b,sidebarRelativePath:F,ignoredRoutes:w})=>{const k=await W(g,d.dirname(d.join(u,F)),r,n,{locale:b,ignoredRoutes:w,navFile:F});if(!k){D.panicOnBuild("Failed to resolve sidebar configuration. Make sure %rp is valid",F);return}return k}))).flat().filter(V),t=T(a,"routeSlug"),i=e[0].sidebarRelativePath,o=await r.createSharedData(H(i),{relatedNavbarItem:Z?.get(i),items:a});for(const g of t)r.addRouteSharedData(g,"sidebar",o),v.set(G(g),a);return{firstLink:_(a,g=>!!g.link),resolved:a}}async function z(e,f,a,t=!1){const i=structuredClone(f);a&&a!==C&&i.items.forEach(s=>{s.directory=d.posix.join(l.localizationFolder||"",a,s.directory||"")});let o=await W(i.items,u,r,n,{groupCustomSidebars:!0,locale:a});if(o&&(o=ue(o)),!o){D.panicOnBuild(`Failed to resolve catalog configuration. Make sure catalog ${e} has valid config`);return}const g=a===C?"":"/"+a.toLowerCase(),b=a===C?"":`-${a}`,F=G(d.posix.join(g,i.slug));if(t)for(const s of o){const m=_(s.items||[],h=>!!h.routeSlug);if(!m?.routeSlug)continue;const p=v.get(m.routeSlug);if(!p)continue;const O=T(p,"routeSlug"),L="current-catalog-info-"+s.routeSlug+b,I={catalog:{label:i.title,titleTranslationKey:i.titleTranslationKey,link:F},item:{label:s.metadata?.title,link:s.link}};await r.createSharedData(L,I);for(const h of O)r.addRouteSharedData(h,"current-catalog-info",L),S.add(h);const U=_(p,h=>!!h.link&&!h.external&&re(h.link)&&(!s.version||h.version===s.version));U&&(s.sidebar=[{...U,items:void 0}])}const w={},k=new Set;for(const s of o){if(!(s.routeSlug||s.sidebar?.[0]?.routeSlug)||!s.fsPath||k.has(s.fsPath))continue;k.add(s.fsPath);const p=d.dirname(s.fsPath);w[p]=(w[p]||0)+1}if(t){const s=await r.createSharedData("catalog-"+e+b,o.flatMap(m=>{const p=d.dirname(m.fsPath??""),O=w[p]===1,L=I=>({...I,fsPath:O?p:I.fsPath??""});return m.type==="group"&&m.items?.every(I=>I.type==="group")?(m.items||[]).map(L):L(m)}));r.addRouteSharedData(F,"catalog",s),de(a,o,$,w)}const J=T(o,"routeSlug");for(const s of J)S.add(s)}}}}function de(u,r,n,c){if(u===C)for(const l of r){const y=l.routeSlug||l.sidebar?.[0]?.routeSlug;if(!y||!l.fsPath)continue;const v=d.dirname(l.fsPath),S=c[v]===1;n.set(y,{rootFileFsPath:l.fsPath,fsPath:S?v:l.fsPath,metadata:l.metadata||{},title:l.metadata?.title||l.label||"Untitled",version:l.version||"latest"})}}function ue(u){const r=n=>{if(!n)return n;const c=Y.parse(n);return ie([c])};return u.map(n=>{const c={...n};return c.metadata?.description&&(c.metadata={...c.metadata,description:r(c.metadata.description)}),c})}function H(u){return ae+oe(u)}async function De(u,r,n){const c=d.posix.join(d.dirname(u),r);return await n.exists(c)?H(c):(D.panicOnBuildContentError(`Failed to create relative path for sidebars.yaml using ${r}`),null)}function ge(u,r){const n=/\/?([a-zA-Z0-9-_]+\/)*sidebars?(-[a-zA-Z0-9-_]+)?\.yaml/;return u.filter(l=>n.test(l)).includes(r)}export{ge as isSidebarIgnored,ue as removeMarkdownTags,De as resolveSidebarId,Le as sidebarsPlugin};
