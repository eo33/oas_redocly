import l from"node:path";import{readFile as y,existsSync as g}from"node:fs";import{promisify as h}from"node:util";import A from"js-yaml";import{canDownloadApiDefinition as F,filterDataByAccessDeep as w}from"../../utils/rbac.js";import{replaceFileExtension as D}from"./store-definition-bundles.js";import{PUBLIC_API_DEFINITIONS_FOLDER as m}from"../../../shared/constants.js";const I=h(y);async function O(t,e){const{isAuthenticated:n,teams:o,claims:{email:i}}=t.get("auth"),a=new URL(t.req.url),s=decodeURIComponent(a.pathname.replace(m,""));if(!F(a.pathname,e.getGlobalConfig("rbac"),e.getGlobalConfig("requiresLogin"),{isAuthenticated:n,email:i,teams:o}))return new Response("Unauthorized",{status:n?403:401});const r=l.join(e.outdir,m,D(s,".json"));if(!g(r))return new Response("Not found",{status:404});const f=await I(r,"utf-8"),u=JSON.parse(f),c=w(u,{isAuthenticated:n,email:i,teams:o},e.config.rbac,e.config.requiresLogin),p=l.extname(s),d=p===".yaml"?A.dump(c):JSON.stringify(c,null,2);return new Response(d,{headers:{"Content-Type":p===".yaml"?"application/yaml":"application/json"}})}export{O as default};
