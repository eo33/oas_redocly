import{redocConfigSchema as A,rootRedoclyConfigSchema as o}from"@redocly/config";import{isTruthy as F}from"@redocly/openapi-core";import S from"is-glob";import{EntitlementsProvider as b}from"../../../entitlements/entitlements-provider.js";import{readAndValidateConfig as g}from"./utils/read-and-validate-config.js";import{resolvePlugins as C}from"../../../config/external-plugins.js";import{Feature as i}from"../../../entitlements/entitlements.types.js";import{deepMerge as h}from"../../../../shared/jsUtils.js";import{CONFIG_FILE_NAME as u,I18N_DIR_NAME as m,L10N_DIR_NAME as l}from"../../../constants.js";import{getPathForAllLocales as p}from"../../../fs/utils/get-path-for-all-locales.js";import{parseRbacConfigToNewFormat as v}from"../../../utils/rbac.js";import{logger as y}from"../../../utils/index.js";import{RbacConfigLocation as R,validateRbacConfig as E}from"../../validate-rbac-config.js";import{DEFAULT_SEARCH_ENGINE as N}from"../../search/constants.js";const V=async(e,{fs:r},n)=>{const t=await g(e,r,n,async s=>e===u?D(r.cwd,s?.plugins||[]):void 0);t?.rbac&&(t.rbac=v(t.rbac),E(t.rbac,e===u?R.RootRedoclyYaml:void 0)),(t?.l10n||t?.i18n)&&(t.l10n=M(t),t.i18n=void 0);const c=h(t||{},{markdown:{partialsFolders:(t?.markdown?.partialsFolders||[]).flatMap(s=>p(s,r))}});return L({...c,configPath:e,ignore:I(t?.ignore,r)})};async function D(e,r){const n=await C(e,r),t=n.map(a=>a.config.ssoSchema||a.config.schema?a.name:""),c=n.map(({config:a})=>a.ssoSchema).filter(F),s=o.properties.ssoDirect,d={};for(const a of n){const f=a.lifecyclePlugin?.id;a.config.schema&&f&&o.properties&&(d[f]=a.config.schema)}return{...o,properties:{...d,...o.properties,openapi:A,ssoDirect:{...s,additionalProperties:{...s.additionalProperties,oneOf:[...s.additionalProperties.oneOf,...c]}}},$id:o.$id+t.join("")}}function L(e){const r=b.instance();return r.canAccessFeature(i.Products)||(e.products=void 0),r.canAccessFeature(i.Breadcrumbs)||(e.breadcrumbs={hide:!0}),r.canAccessFeature(i.Seo)||(e.seo=void 0),r.canAccessFeature(i.Redirects)||(e.redirects={}),r.canAccessFeature(i.L10n)||(e.l10n=void 0),r.canAccessFeature(i.Rbac)||(e.rbac=void 0),r.canAccessFeature(i.Sso)||(e.sso=void 0),r.canAccessFeature(i.SsoDirect)||(e.ssoDirect=void 0),r.canAccessFeature(i.Catalog)||(e.catalog=void 0),r.canAccessFeature(i.Scorecard)||(e.scorecard=void 0),r.canAccessFeature(i.DevOnboarding)||(e.developerOnboarding=void 0),r.canAccessFeature(i.Analytics)||(e.analytics=void 0),r.canAccessFeature(i.RemoveAttribution)||(e.removeAttribution=void 0),r.canAccessFeature(i.MockServer)||(e.mockServer={off:!0}),r.canAccessFeature(i.AdvancedSearch)||e.search&&(e.search.engine=N),e}function I(e=[],r){return["static",...e].flatMap(n=>S(n)&&(n.startsWith("*")||n.startsWith(l)||n.startsWith("/"+l)||n.startsWith(m)||n.startsWith("/"+m))?n:p(n,r))}function M(e){return e.i18n&&y.warn("The `i18n` configuration is deprecated. Please use `l10n` instead."),e.l10n||e.i18n||{}}export{V as redoclyConfigLoader};
