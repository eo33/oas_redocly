import*as p from"path";import{REDOCLY_ROUTE_RBAC as y,REDOCLY_TEAMS_RBAC as g}from"../../shared/constants.js";import{removeTrailingSlash as $,isPrimitive as x,slash as F}from"../../shared/utils.js";import{VERSION_SEPARATOR as M}from"../constants.js";import{copyStaticFile as V}from"../utils/fs.js";import{logger as j,reporter as O}from"../utils/index.js";import{resolveSrcSet as _}from"../utils/resolve-src-set.js";import{parsePathVersions as C}from"./config-parser/loaders/versions-config-loader.js";import{isL10nPath as A}from"../fs/utils/is-l10n-path.js";import{getLocaleFromRelativePath as D}from"../fs/utils/get-locale-from-relative-path.js";async function L(e,t,a,n,s={}){if(!e)return;const l={...s,ignoreCustomSidebar:!0};if(x(e)){if(typeof e=="string"){const r=S(a.contentDir,t,s,e,n.fs);if(await n.fs.exists(r)){if(a.getRouteByFsPath(r))return B({page:e},t,a,n,l);{const i=await n.fs.getFileInfo(r);return i?V(a.contentDir,i.realRelativePath,a.outdir):void 0}}}return e}return Array.isArray(e)?I(N(e),t,a,n,l):Object.fromEntries(await Promise.all(Object.entries(e).map(async([r,d])=>[r,await L(d,t,a,n,s)])))}function N(e){return e.map(t=>({...t,items:t.items?N(t.items):void 0}))}async function I(e,t,a,n,s={}){if(Array.isArray(e))return(await Promise.all(e.map(l=>B(l,t,a,n,s)))).flatMap(l=>l)}async function P(e,t,a,n){let s,l;return typeof e.icon=="object"?"srcSet"in e.icon&&(s=await _(e.icon.srcSet,"items.icon.srcSet",n.fs,a.contentDir,a.outdir)):typeof e.icon=="string"&&(l=await L(e.icon,t,a,n)),{icon:l,srcSet:s}}function W(e){return t=>{if(t.type==="link"||t.type==="group"){const a=t.metadata;return a?Object.entries(e).every(([n,s])=>Array.isArray(s)?s.some(l=>a[n]===l):a[n]===s):!1}return!0}}async function B(e,t,a,n,s={}){if(e?.directory&&e.items?.length)return{type:"error",label:`Can't have both "directory" and "items" in the nav item: ${JSON.stringify(e)}`};e?.directory&&e?.group&&(e={...e,directory:void 0,items:[{directory:e.directory}]});const l=e?.directory?S(a.contentDir,t,s,e.directory,n.fs):void 0;if(l!==void 0){const i=l===""?"":l+"/",{locale:c,ignoredRoutes:u}=s;let v=a.getAllRoutesForLocale(c).filter(o=>!u?.has(o.baseSlug||"")&&o.fsPath.startsWith(i)&&!o.excludeFromSidebar).sort((o,h)=>o.fsPath===h.fsPath?0:o.slug.localeCompare(h.slug,void 0,{numeric:!0}));const b=e.includeByMetadata?W(e.includeByMetadata):Boolean;if(!v.length)return[];const m=(await Promise.all(v.map(async o=>{const h=o.versions?.find(K=>K.active),k=h&&{version:h.version,isDefault:h.default,versionFolderId:h.folderId},E=Y(p.posix.relative(l,o.fsPath)),T=o.getSidebar?.(o);return!s.ignoreCustomSidebar&&T?.length?{type:"group",fsPath:o.fsPath,metadata:o.metadata,link:o.slug,routeSlug:o.slug,label:await o.getNavText?.()||o.slug,[g]:o[g],[y]:o[y],sidebarItems:R(T,k,o[g],o[y]),...k,relativePathFromDirectory:p.relative(l,o.fsPath).replace(/@[^\/]+\//,"")}:{type:"link",fsPath:o.fsPath,metadata:o.metadata,[g]:o[g],[y]:o[y],label:await o.getNavText?.()||o.slug,link:o.slug,routeSlug:o.slug,...k,relativePathFromDirectory:E}}))).filter(b);return e.flatten?w(m,s):J(m,s)}let f=typeof e=="string"?e:e?.page,r;f&&(f=$(f),r=a.getRouteBySlug(f),r||(r=a.getRouteByFsPath(S(a.contentDir,t,s,f,n.fs))));const d=r?.metadata;if(e?.$ref){let i=S(a.contentDir,t,s,e.$ref,n.fs);if(s.ref!==void 0&&(i=p.posix.join(s.ref,e.$ref)),!await n.fs.exists(i))return O.panicOnBuildContentError(`Failed to load ${i} file. Make sure sidebar $ref path is correct.`),[];const c=await n.cache.load(i,"yaml"),u=p.dirname(i);return await I(c.data,t,a,n,{...s,ref:u})||[]}if(r||await z(e,s,n,t),r?.getSidebar&&!e.disconnect&&!s.ignoreCustomSidebar){const i=r.versions?.find(b=>b.active),c=i&&{version:i.version,isDefault:i.default,versionFolderId:i.folderId},u=r.getSidebar(r,{...e,...await P(e,t,a,n)}),v=e.group&&u?.[0]?.routeSlug===r.slug?u.slice(1):u;return R(s.groupCustomSidebars||e.group?[{type:"group",fsPath:r.fsPath,link:r.slug,routeSlug:r.slug,label:e.group||await r.getNavText?.()||r.slug,items:v,metadata:d,...await P(e,t,a,n)}]:u,c,r[g],r[y])}if(r&&!e.group){const i=r.slug,c=e.group||e.label||await r.getNavText?.()||r.slug,u=r.versions?.find(b=>b.active),v=u&&{version:u.version,isDefault:u.default,versionFolderId:u.folderId};return{type:"link",fsPath:r.fsPath,linkedSidebars:e.linkedSidebars,metadata:d,[g]:e?.rbac||r[g],[y]:{slug:r.slug,fsPath:r.fsPath},label:c,labelTranslationKey:e.labelTranslationKey,link:i,items:await I(e.items,t,a,n),separatorLine:e.separatorLine,linePosition:e.linePosition,routeSlug:e.disconnect?void 0:i,external:e.external,target:e.target,...await P(e,t,a,n),...v}}else if(e?.group){const i=C(s?.navFile||"")?.versionName;return{type:"group",fsPath:r?.fsPath,linkedSidebars:e.linkedSidebars,metadata:d,version:i,label:e.group,link:r?.slug,routeSlug:r?.slug,labelTranslationKey:e.groupTranslationKey,items:await I(e.items,t,a,n,s),expanded:e.expanded?e.expanded.toString():void 0,selectFirstItemOnExpand:e.selectFirstItemOnExpand,menuStyle:e.menuStyle,separatorLine:e.separatorLine,linePosition:e.linePosition,...await P(e,t,a,n),[g]:e?.rbac,[y]:{slug:r?.slug||"",fsPath:r?.fsPath||""}}}else{if(e?.href||e?.label)return{type:"link",metadata:d,link:e.href||"",label:e?.label||e?.href||"",labelTranslationKey:e.labelTranslationKey,external:e.external,target:e.target,separatorLine:e.separatorLine,linePosition:e.linePosition,...await P(e,t,a,n),[g]:e?.rbac};if(e?.separator!=null||e?.separatorLine!=null){const i=C(s?.navFile||"")?.versionName;return{type:"separator",metadata:d,version:i,label:e.separator,labelTranslationKey:e.separatorTranslationKey,separatorLine:e.separatorLine,linePosition:e.linePosition,[g]:e?.rbac}}else return{type:"error",label:`Can't resolve page: ${JSON.stringify(e)}`}}}async function z(e,t,a,n){const{href:s,page:l}=e;if(s||!l)return;const f=S(a.fs.cwd,n,t,l,a.fs),r=await a.fs.exists(f),d=await a.isPathIgnored(f),i=(r?"The page is ignored: ":"Can't resolve page: ")+l;(!r||d)&&O.reportBrokenLink({type:"BROKEN_LINK",brokenLinkType:"LINK",title:e.label||e.group||"",link:f,rawLink:l,message:i,sourceFileRelativePath:t.navFile||"",sourceFileLocation:{line:0}})}function S(e,t,a,n="",s){if(a.ref!==void 0)return F(p.relative(e,p.resolve(e,p.join(a.ref,n))));if(n.startsWith("/")){const l=A(t)?D(t):void 0,f=l?`${s.localizationFolder}/${l}/`:"",r=n.slice(1);return A(r)?r:f+F(r)}return F(p.relative(e,p.resolve(e,t,n)))}function J(e,t={}){const a={};for(const r of e){const d=p.dirname(r.relativePathFromDirectory),i=r.version?M+r.version:"",c=p.basename(r.relativePathFromDirectory)+i;f(d,r,c)}const n=l(s(a));return w(n,t);function s(r){const d=[];for(const i of Object.keys(r)){const c=r[i];d.push({...c,items:c.items?s(c.items):void 0})}return d}function l(r){return r.sort((d,i)=>{const c=typeof d=="string"?d.toLowerCase():d.relativePathFromDirectory||d.label||"",u=typeof i=="string"?i.toLowerCase():i.relativePathFromDirectory||i.label||"";return c.startsWith("index.")?-1:u.startsWith("index.")?1:c.localeCompare(u)})}function f(r,d,i){r==="."&&(r="");const c=r.split("/").filter(Boolean);let u=a;for(const v of c){const b=v+(d?.version||"");u[b]||(u[b]={type:"group",version:d?.version,label:v,isDefault:d?.isDefault,versionFolderId:d.versionFolderId,items:{}}),u=u[b].items}u[i]=d}}function w(e,t){return e.flatMap(a=>a?.sidebarItems?t.groupCustomSidebars?{...a,items:a.sidebarItems,sidebarItems:void 0,relativePathFromDirectory:void 0}:a.sidebarItems:{...a,items:a.items?w(a.items,t):void 0})}function R(e,t,a,n){return e.map(s=>({...s,...t,[g]:s[g]||a,[y]:s[y]||n,items:s.type==="group"&&s.items?R(s.items,t,a):s.items}))}function Y(e){return e.replace(/@[^\/]+\//,"")}async function ae(e,t,a){const n=(e?.items||[]).filter(f=>f.linkedSidebars?.length).map(f=>({...f,items:void 0})),s=await L(n,t.contentDir,t,a),l=new Map;for(const f of s)if(f.linkedSidebars?.length)for(const r of f.linkedSidebars){if(l.has(r)){j.warn(`Only one navbar item can belong to sidebar. "${r}" on 'linkedSidebars' property on "${f.label}" will be ignored.`);continue}l.set(r,{label:f.label,link:f.link})}return l}export{ae as collectItemsLinkedToSidebars,N as normalizeItems,B as resolveItem,I as resolveItems,L as resolveLinksFromConfig};
