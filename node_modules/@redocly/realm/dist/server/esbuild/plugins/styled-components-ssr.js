import _ from"@babel/core";import t from"fs";import E from"os";import d from"path";import S from"babel-plugin-styled-components";import A from"crypto";import I from"lru-cache";import{exit as x}from"../../utils/process.js";import{PORTAL_VERSION as h}from"../../version.js";const m=".cache/babel-plugin",o=t.existsSync("node_modules")?`node_modules/${m}`:d.join(E.tmpdir(),".redocly",m),a="styled-cache.json",O=5e3,$=15e3,C="_package-version",e=new I({max:O});v(),w(),b(),N();const k=()=>({name:"styled-components-ssr",setup:c=>{const y=process.cwd();c.onLoad({filter:/\.[tj]sx?$/},async s=>{if(s.path.endsWith(`${d.sep}replay.js`))return;let n=s.path.split(".").pop();const r=e.get(s.path);if(r&&s.path.includes("/node_modules/"))return{contents:r.contents,loader:n};let l=["importMeta","topLevelAwait","classProperties","classPrivateProperties","classPrivateMethods","jsx"];(n==="tsx"||n==="ts")&&l.push("typescript");let i=await t.promises.readFile(s.path,"utf8");if(i.indexOf("styled-components")===-1)return{contents:i,loader:n};const f=A.createHash("sha1").update(i).digest("base64");if(r&&r.hash===f)return{contents:r.contents,loader:n};const u=(await _.transformAsync(i,{babelrc:!1,configFile:!1,ast:!1,root:y,filename:s.path,parserOpts:{allowAwaitOutsideFunction:!0,plugins:l},generatorOpts:{decoratorsBeforeExport:!0},plugins:[S],sourceMaps:!1}))?.code||void 0;return e.set(s.path,{contents:u,hash:f}),{contents:u,loader:n}})}});function v(){if(!t.existsSync(`${o}/${a}`)){e.load([]);return}const c=JSON.parse(t.readFileSync(`${o}/${a}`,"utf-8"));try{if(e.load(c),e.get(C)?.contents!==h)throw new Error("Cache version mismatch")}catch{e.load([]),t.unlinkSync(`${o}/${a}`)}}function p(){t.existsSync(o)||t.mkdirSync(o,{recursive:!0}),e.set(C,{contents:h||"",hash:""}),t.writeFileSync(`${o}/${a}`,JSON.stringify(e.dump()),"utf-8")}function w(){process.on("SIGINT",()=>{p(),x(0)})}function b(){process.on("exit",()=>{p()})}function N(){setInterval(()=>{p()},$).unref()}export{k as StyledComponentsSSR};
