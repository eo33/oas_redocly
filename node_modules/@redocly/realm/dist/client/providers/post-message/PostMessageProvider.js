import n,{createContext as R,useEffect as v}from"react";import{useLocation as M,useNavigate as S}from"react-router-dom";import{withPathPrefix as C}from"../../../shared/urls";import{ServerRoutes as E}from"../../../shared/constants";import{normalizeRouteSlug as g,removeTrailingSlash as L}from"../../../shared/utils";import{loadAndNavigate as U}from"../../app/utils/loadAndNavigate";import{syncScrollWithEditor as x}from"../../app/utils/syncScrollWithEditor";import{PostMessageConnection as O}from"./PostMessageConnection";import{isHostnameOnDomain as s}from"../../app/utils/isHostnameOnDomain";const T=R({sendMessage:()=>{}});function V({children:c,enabled:o}){const k=S(),l=M(),i=n.useRef(null),u=n.useCallback(e=>{i.current?.send(e)},[]),m=n.useCallback(e=>{console.info("[PM] connection initialized."),i.current=new O(e.source,e.origin),u({type:"initialized"})},[u]),h=n.useCallback(async e=>{const{path:r="/",line:t=1,url:w}=e;let a=w;if(!w)try{const d=await fetch(C(E.RESOLVE_ROUTE_BY_PATH),{method:"POST",body:JSON.stringify(r+(t?`:${t}`:""))}),{route:b}=await d.json();a=b?.slug??b?.url??void 0}catch(d){console.error(d)}if(!a)return;a=a==="/"?"/":L(a);const[y,P]=a.split("#");g(y)===g(l.pathname)&&(P??"")===l.hash.substring(1)||(console.info("[PM] Update route to: ",a),await U(k,a,"pm"))},[l]),f=n.useCallback(async e=>{const{action:r}=e;switch(r){case"back":window.history.back();break;case"forward":window.history.forward();break;case"reload":window.location.reload();break}},[]),p=n.useCallback(e=>{window.scrollTo({top:e.position.absolute,behavior:"instant"})},[]);return v(()=>{if(!o)return;const e=async r=>{if(!z(r.origin))return;const t=r.data;switch(t.type){case"initialize":m(r);break;case"route-update":if(!i.current)return;h(t);break;case"location-update":if(!i.current)return;f(t);break;case"scroll-update":if(!i.current)return;p(t);break;case"editor-scroll-update":if(!i.current)return;x(t.percentScrolled,t.sequenceNumber);break}};return window.addEventListener("message",e),()=>{window.removeEventListener("message",e)}},[o,m,h,f,p]),n.createElement(T.Provider,{value:{sendMessage:u}},c)}function z(c){const o=new URL(c);return s(o.hostname,"localhost")||s(o.hostname,"127.0.0.1")||s(o.hostname,"blueharvest.cloud")||s(o.hostname,"bhstage.cloud")||s(o.hostname,"cloud.redocly.com")||s(o.hostname,"cloud.eu.redocly.com")||s(o.hostname,"cba.au.redocly.com")}export{T as PostMessageContext,V as PostMessageProvider};
