import*as h from"react";import{useLocation as j,useNavigate as B}from"react-router-dom";import{telemetry as A}from"@portal/telemetry";import{usePageData as R,usePageSharedData as V}from"@portal/hooks";import{findDeepFirst as G,partition as $,toStringIfDefined as C}from"../../../../shared/jsUtils";import{withoutHash as _}from"../../../../shared/urls";function te(e,s){const t=j(),i=B(),a=R(),r=K(t),n=V("catalog"),[o,g]=h.useState(()=>(e.filters??[]).map(l=>{if(l.type==="date-range"){const[c,u]=r.get(l.property)?.split("--")??[];return!c&&!u?{}:{from:c,to:u}}return new Set(r.getAll(l.property))})),[p,f]=h.useState(()=>r.get("filter")||"");s||(s=[...n]);const S=h.useMemo(()=>D(s??[],e.filters),[s,e.filters]),I=a?.props?.customFields,w=h.useMemo(()=>Z(s??[],e,I||{}),[s,e,I]),b=h.useCallback((l,c)=>{g(u=>{const y=u[l]?u[l]:new Set;return y instanceof Set?(y.has(c)?u.forEach((d,m)=>{d instanceof Set&&d.has(c)&&d.delete(c)}):y.add(c),[...u.slice(0,l),y,...u.slice(l+1)]):u}),A.send("catalog_filter_changed",{type:"toggle"}),window.scrollTo(0,0)},[]),P=h.useCallback((l,c)=>{g(u=>{const y=u[l]instanceof Set?new Set(c?[c]:[]):{from:c?.from,to:c?.to},d=S[l];return u.map((m,F)=>F===l?y:S[F].parentFilter===d.property?new Set:m)}),A.send("catalog_filter_changed",{type:"select"}),window.scrollTo(0,0)},[S]),T=()=>{const l=new URLSearchParams(Array.from(r.entries()));p?r.set("filter",p):r.delete("filter"),o.forEach((u,y)=>{const d=e.filters?.[y];if(!d)return;const m=Q(u);J(d.property,m,l)});const c=l.toString();c!==t.search.substring(1)&&i({search:c})};h.useEffect(()=>{T()},[e.filters,o,p,i,t]);const k=h.useMemo(()=>q(e.filters),[e.filters]);return h.useMemo(()=>{const l=S.map((d,m)=>({...d,toggleOption:F=>b(m,F),selectOption:F=>P(m,F),selectedOptions:o[m]??new Set,isFilterUsed:(o[m]?.size??0)>0||!!o[m]?.from})),c=L(w,l,p),u=l.map((d,m)=>{const F=l.findIndex(O=>O.property===d.parentFilter),E=d.parentFilter?(o[F]?.size??0)>0||!!o[F].from:!0,z=l.filter((O,v)=>v!==m&&!k[m]?.has(v)),N=L(w,z,p),U=D(N.map(O=>({metadata:O})),e.filters);return{...d,parentUsed:E,filteredOptions:U[m].options}});return{groups:e.groupByFirstFilter&&u.length>0?H(u,c):[{title:"APIs",items:c}],filters:u,setFilterTerm:d=>{f(d),A.send("catalog_filter_changed",{type:"term"})},filterTerm:p}},[S,w,p,e.groupByFirstFilter,e.filters,o,b,P,k])}function H(e,s){return e[0].options.map(t=>({title:t.value,items:s.filter(i=>{const a=i?.[e[0].property]||e[0].missingCategoryName||"Others";return Array.isArray(a)?a.includes(t.value):a===t.value})})).filter(t=>t.items.length>0)}function K(e){return h.useMemo(()=>new URLSearchParams(e.search),[e.search])}function Z(e,s,t){let i;return s.separateVersions?i=e.map(a):i=$(e,n=>n.versionFolderId).map(n=>{n.sort((p,f)=>(p.version||"").localeCompare(f.version||""));const o=n.map(a);return{...a(n.find(p=>p.isDefault)||n[n.length-1]),versions:o}}),i.sort((r,n)=>r.title.localeCompare(n.title)),i;function a(r){const n=r.metadata||{},o=t[r.fsPath||""]||{},g=r.link||G(r.items||[],f=>"link"in f&&!!f.link)?.link,p=r.sidebar?.[0];return{...n,...o,publishedAt:n.publishedAt||n.createdAt,title:C(n?.title)||r.label||"Untitled",description:C(n?.description),link:_(g)??"#",docsLink:_(p?.link),image:C(n?.image),version:r.version,versionFolderId:r.versionFolderId}}}function q(e){if(!e)return[];const s=[];for(let t=0;t<e.length;t++){const i=e[t];if(i.parentFilter){const a=e.findIndex(r=>r.property===i.parentFilter);s[a]=s[a]||new Set,s[a].add(t)}}return s}function D(e,s){return(s??[]).map(t=>{const i=t.options?Object.fromEntries(t.options.map(o=>[o,0])):void 0,a=i??{};let r=0;for(const o of e){const g=Array.isArray(o.metadata?.[t.property])?o.metadata?.[t.property]:[o.metadata?.[t.property]];for(const p of g){const f=M(String(p),t.valuesMapping);if(i){f in i&&(a[f]=a[f]+1);continue}p?a[f]=(a[f]??0)+1:r++}}const n=Object.entries(a).map(([o,g])=>({value:o,count:g}));return i||n.sort((o,g)=>o.value.localeCompare(g.value)),r&&n.push({value:t.missingCategoryNameTranslationKey||t.missingCategoryName||"Others",count:r}),{...t,options:n}})}function L(e,s,t){const i=e.filter(a=>s.every(r=>{if(r.selectedOptions&&!(r.selectedOptions instanceof Set))try{const o=new Date(a[r.property]).toISOString().split("T")[0];return o>=(r.selectedOptions.from??"")&&o<=(r.selectedOptions.to??"Z")}catch{return!0}if(r.selectedOptions.size===0)return!0;const n=M(a?.[r.property]||r.missingCategoryName||"Others",r.valuesMapping);return Array.isArray(n)?n.some(o=>r.selectedOptions.has(o)):r.selectedOptions.has(n)}));return t?(t=t.toLowerCase(),i.filter(a=>Object.values(a).some(r=>Array.isArray(r)?r.some(n=>String(n).toLowerCase().includes(t)):String(r).toLowerCase().includes(t)))):i}function M(e,s){return s?Array.isArray(e)?e.map(t=>s[String(t)]||t):s[String(e)]||e:e}function J(e,s,t){t.delete(e),s.forEach(i=>{t.append(e,i)})}function Q(e){const s=new Set;return e instanceof Set?e.forEach(t=>s.add(t)):(e.from||e.to)&&s.add(`${e.from||""}--${e.to||""}`),s}export{J as fillSearchParams,Q as getFilterValues,te as useCatalog};
