import{useCallback as _,useEffect as P,useState as R,useRef as L}from"react";import{useRecentSearches as j}from"@redocly/theme/core/hooks";import{useGlobalData as N,useI18nConfig as g}from"../hooks";import{withPathPrefix as O}from"../../../shared/urls";import{ServerRoutes as b}from"../../../shared/constants";import{debounce as G}from"../../../shared/jsUtils";import{usePageVersions as k}from"../../providers/page-data/hooks";import{useFacets as x}from"./useFacets";const J=300,M="redocly_product",Q="redocly_version",U=(t,r,e,i,c,a,s,f)=>{const{currentLocale:d}=g(),{addSearchHistoryItem:p}=j(),l=L("");P(()=>{f||(c(!0),E(t,r,d,s),l.current=t)},[t,r,a?.version,a?.folderId,s,f]);const E=_(G(async(o,m,u,h)=>{if(!o.trim().length&&!m.length){e({}),i({}),c(!1);return}const S={method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({query:o,filter:H(m,h,a),locale:u})};p(o);try{const n=await fetch(O(b.SEARCH),S);if(l.current===o){const I=await n.json();i(I.facets),e(I.documents)}c(!1)}catch(n){e({}),console.log(n)}},J),[a?.version,a?.folderId,s]);return{}},B=(t,r,e,i,c,a,s,f)=>{const{currentLocale:d}=g();P(()=>{p(e,t,r,d,i,c,f)},[i,f]);const p=_(async(l,E,o,m,u,h,S)=>{if(u){const{groupKey:n}=u;s(!0);const y={method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({query:E,filter:(()=>{const F=h.find(C=>C.isTop);return F&&!o.find(D=>D.field===F?.field)?[...o,{field:F.field,values:[n],isTop:!0}]:H(o,S)})(),loadMore:u,locale:m})},T=await(await fetch(O(b.SEARCH),y)).json(),v=l[n]||[],w=T.documents[n],A={...l,[n]:[...v,...w]};a(A),s(!1)}},[]);return{}};function ee(t,r){const{advancedSearch:e,askAi:i}=N(),[c,a]=R(""),[s,f]=R([]),[d,p]=R({}),[l,E]=R({}),[o,m]=R(),[u,h]=R(!1),{facets:S}=x(l),{versions:n=[]}=k()||{},I=n.find(y=>y?.active);return U(c,s,p,E,h,I,t,r),B(c,s,d,o,S,p,h,t),{query:c,setQuery:a,filter:s,setFilter:f,items:d,isSearchLoading:u,facets:S,setLoadMore:m,advancedSearch:e,askAi:i}}function H(t,r,e){return[...t,...r?[{field:M,values:[r]}]:[],...e?[{field:Q,values:[...e.default?["default"]:[e.folderId,e.version]]}]:[]]}export{ee as useSearch};
